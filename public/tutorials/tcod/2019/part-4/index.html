<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Part 4 - Field of View" />
<meta property="og:description" content="We have a dungeon now, and we can move about it freely. But are we really exploring the dungeon if we can just see it all from the beginning?
Most roguelikes (not all!) only let you see within a certain range of your character, and ours will be no different. We need to implement a way to calculate the &ldquo;Field of View&rdquo; for our adventurer, and fortunately, libtcod makes that easy!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://rogueliketutorials.com/tutorials/tcod/2019/part-4/" /><meta property="article:section" content="tutorials" />
<meta property="article:published_time" content="2019-03-30T09:33:44-07:00" />
<meta property="article:modified_time" content="2019-03-30T09:33:44-07:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Part 4 - Field of View"/>
<meta name="twitter:description" content="We have a dungeon now, and we can move about it freely. But are we really exploring the dungeon if we can just see it all from the beginning?
Most roguelikes (not all!) only let you see within a certain range of your character, and ours will be no different. We need to implement a way to calculate the &ldquo;Field of View&rdquo; for our adventurer, and fortunately, libtcod makes that easy!"/>



    <link rel="canonical" href="https://rogueliketutorials.com/tutorials/tcod/2019/part-4/">

    <title>
      
        Part 4 - Field of View | Roguelike Tutorials
      
    </title>

    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="https://rogueliketutorials.com/css/style.css" rel="stylesheet">

    

    

    
  </head>
  <body>
    
      

<header class="blog-header">
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <a class="navbar-brand" href="/">
            Roguelike Tutorials
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
            <ul class="navbar-nav">
                
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/">Home</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/tutorials/tcod/2019/">TCOD Tutorial (2019)</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/tutorials/tcod/v2/">TCOD Tutorial (2020)</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/about/">About</a>
                    
                </li>
                
            </ul>
            
        </div>
    </nav>
</header>

    

    
    <div class="container">
      <div class="row">
        <div class="col-12 col-lg-8 blog-main">

          

<header>
    <h2 class="blog-post-title">
    <a class="text-dark" href="/tutorials/tcod/2019/part-4/">Part 4 - Field of View</a>
</h2>

    


<div class="blog-post-date text-secondary">
    
        <time datetime="2019-03-30">Mar 30, 2019</time>
    
    
</div>

    
    
    <hr>
</header>
<article class="blog-post">
    <p>We have a dungeon now, and we can move about it freely. But are we
really <em>exploring</em> the dungeon if we can just see it all from the
beginning?</p>
<p>Most roguelikes (not all!) only let you see within a certain range of
your character, and ours will be no different. We need to implement a way
to calculate the &ldquo;Field of View&rdquo; for our adventurer, and fortunately,
libtcod makes that easy!</p>
<p>We&rsquo;ll need to define a few variables before we get started. Add these in
the same section as our screen and map variables:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    max_rooms = 30

<span style="color:#a6e22e">+   fov_algorithm = 0
</span><span style="color:#a6e22e">+   fov_light_walls = True
</span><span style="color:#a6e22e">+   fov_radius = 10
</span><span style="color:#a6e22e"></span>
    colors = {
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    max_rooms = 30

    <span class="new-text">fov_algorithm = 0
    fov_light_walls = True
    fov_radius = 10</span>

    colors = {
    ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>&lsquo;0&rsquo; is just the default algorithm that libtcod uses; it has more, and I
encourage you to experiment with them later. <code>fov_light_walls</code> just
tells us whether or not to &lsquo;light up&rsquo; the walls we see; you can change
it if you don&rsquo;t like the way it looks. <code>fov_radius</code> is somewhat obvious,
it tells us how far we can actually see.</p>
<p>We also need to update the <code>colors</code> dictionary, because now we need two
more colors for the &lsquo;light&rsquo; versions of both walls and floors. Walls and
floors in our fov will be &lsquo;lit&rsquo;, distinguishing them from the ones
outside what we can see.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3">    colors <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;dark_wall&#39;</span>: libtcod<span style="color:#f92672">.</span>Color(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">100</span>),
        <span style="color:#e6db74">&#39;dark_ground&#39;</span>: libtcod<span style="color:#f92672">.</span>Color(<span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">150</span>),
        <span style="color:#e6db74">&#39;light_wall&#39;</span>: libtcod<span style="color:#f92672">.</span>Color(<span style="color:#ae81ff">130</span>, <span style="color:#ae81ff">110</span>, <span style="color:#ae81ff">50</span>),
        <span style="color:#e6db74">&#39;light_ground&#39;</span>: libtcod<span style="color:#f92672">.</span>Color(<span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">180</span>, <span style="color:#ae81ff">50</span>)
    }</code></pre></div>
<p><em>* Don&rsquo;t forget to add the comma after the &lsquo;dark_ground&rsquo; entry; Python
will throw an error without it!</em></p>
<p>If you don&rsquo;t like these colors, feel free to change them to your liking.</p>
<p>The thing about field of view is that it doesn&rsquo;t need to be computed
every turn. In fact, it would be quite a waste to do so! We really only
need change it when the player moves. Attacking, using an item, or just
standing still for a turn doesn&rsquo;t alter FOV. We can handle this by
having a boolean variable, which we&rsquo;ll call <code>fov_recompute</code>, which tells
us if we need to recompute. We can define it somewhere above our game
loop (I put mine right after the map initialization).</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    game_map.make_map(max_rooms, room_min_size, room_max_size, map_width, map_height, player)

<span style="color:#a6e22e">+   fov_recompute = True
</span><span style="color:#a6e22e"></span>
    key = libtcod.Key()
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    game_map.make_map(max_rooms, room_min_size, room_max_size, map_width, map_height, player)

    <span class="new-text">fov_recompute = True</span>

    key = libtcod.Key()
    ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>It&rsquo;s <code>True</code> by default, because we have to compute it right when the
game starts.</p>
<p>Now let&rsquo;s initialize our field of view, which we&rsquo;ll store in a variable
called <code>fov_map</code>. <code>fov_map</code> will need to not only be initialized, but
recomputed when the player moves. Let&rsquo;s keep these functions out of
<code>engine.py</code>, and instead, put them in a new file, called
<code>fov_functions.py</code>. In that file, put the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#f92672">import</span> tcod <span style="color:#66d9ef">as</span> libtcod


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize_fov</span>(game_map):
    fov_map <span style="color:#f92672">=</span> libtcod<span style="color:#f92672">.</span>map_new(game_map<span style="color:#f92672">.</span>width, game_map<span style="color:#f92672">.</span>height)

    <span style="color:#66d9ef">for</span> y <span style="color:#f92672">in</span> range(game_map<span style="color:#f92672">.</span>height):
        <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(game_map<span style="color:#f92672">.</span>width):
            libtcod<span style="color:#f92672">.</span>map_set_properties(fov_map, x, y, <span style="color:#f92672">not</span> game_map<span style="color:#f92672">.</span>tiles[x][y]<span style="color:#f92672">.</span>block_sight,
                                       <span style="color:#f92672">not</span> game_map<span style="color:#f92672">.</span>tiles[x][y]<span style="color:#f92672">.</span>blocked)

    <span style="color:#66d9ef">return</span> fov_map</code></pre></div>
<p>Call this function in <code>engine.py</code> and store the result in <code>fov_map</code>.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    fov_recompute = True

<span style="color:#a6e22e">+   fov_map = initialize_fov(game_map)
</span><span style="color:#a6e22e"></span>
    key = libtcod.Key()
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    fov_recompute = True

    <span class="new-text">fov_map = initialize_fov(game_map)</span>

    key = libtcod.Key()
    ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Don&rsquo;t forget the import for the function.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">...
from entity import Entity
<span style="color:#a6e22e">+from fov_functions import initialize_fov
</span><span style="color:#a6e22e"></span>from input_handlers import handle_keys
...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>...
from entity import Entity
<span class="new-text">from fov_functions import initialize_fov</span>
from input_handlers import handle_keys
...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>While we&rsquo;re at it, let&rsquo;s modify the section where we move the player to
set <code>fov_recompute</code> to True.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">                ...
                player.move(dx, dy)

<span style="color:#a6e22e">+               fov_recompute = True
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>                ...
                player.move(dx, dy)

                <span class="new-text">fov_recompute = True</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>But where does the recompute actually <em>happen</em>? For that, let&rsquo;s add a
new function to <code>fov_functions.py</code> to do the recomputing. The recompute
function will modify the <code>fov_map</code> variable based on where the player
is, what the radius for lighting is, whether or not to light the walls,
and what algorithm we&rsquo;re using.</p>
<p>That&rsquo;s a lot of variables, but consider this: in your game, you&rsquo;ll
probably pick one FOV algorithm and stick with it. Also, whether or not
you light the walls probably won&rsquo;t change during the course of the game.
So why not create our function with default arguments? That way, we can
pass the <code>light_walls</code> and <code>algorithm</code> variables if we want to, but if
not, a default is chosen. That looks like this:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def initialize_fov(game_map):
    ...

<span style="color:#a6e22e">+def recompute_fov(fov_map, x, y, radius, light_walls=True, algorithm=0):
</span><span style="color:#a6e22e">+   libtcod.map_compute_fov(fov_map, x, y, radius, light_walls, algorithm)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>def initialize_fov(game_map):
    ...

<span class="new-text">def recompute_fov(fov_map, x, y, radius, light_walls=True, algorithm=0):
    libtcod.map_compute_fov(fov_map, x, y, radius, light_walls, algorithm)</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>So when we call the function, we have to give fov_map, x, y, and
radius, but we don&rsquo;t necessarily have to pass in light_walls or
algorithm. In my <code>engine.py</code> file, I&rsquo;ll pass them in anyway, but you
don&rsquo;t have to if you don&rsquo;t want to (you can also change the defaults I
gave above to whatever you prefer).</p>
<p>Whatever you decide, put your fov recomputation in <code>engine.py</code> like so:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        libtcod.sys_check_for_event(libtcod.EVENT_KEY_PRESS, key, mouse)

<span style="color:#a6e22e">+       if fov_recompute:
</span><span style="color:#a6e22e">+           recompute_fov(fov_map, player.x, player.y, fov_radius, fov_light_walls, fov_algorithm)
</span><span style="color:#a6e22e"></span>
        render_all(con, entities, game_map, screen_width, screen_height, colors)
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        libtcod.sys_check_for_event(libtcod.EVENT_KEY_PRESS, key, mouse)

        <span class="new-text">if fov_recompute:
            recompute_fov(fov_map, player.x, player.y, fov_radius, fov_light_walls, fov_algorithm)</span>

        render_all(con, entities, game_map, screen_width, screen_height, colors)
        ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>&hellip; And, of course, we have to import that function:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">...
from entity import Entity
<span style="color:#f92672">-from fov_functions import initialize_fov
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+from fov_functions import initialize_fov, recompute_fov
</span><span style="color:#a6e22e"></span>from input_handlers import handle_keys
...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>...
from entity import Entity
from fov_functions import initialize_fov<span class="new-text">, recompute_fov</span>
from input_handlers import handle_keys
...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Now, after the player successfully moves, the field of view will be set
to recalculate, but it won&rsquo;t if we do something else.</p>
<p>With our field of view calculated, we need to actually <em>display</em> it (if
you run the code now, you won&rsquo;t notice any visible change). Open up
<code>render_functions.py</code> and modify the <code>render_all</code> function like
this:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def render_all(con, entities, game_map, screen_width, screen_height, colors):
<span style="color:#a6e22e">+def render_all(con, entities, game_map, fov_map, fov_recompute, screen_width, screen_height, colors):
</span><span style="color:#a6e22e"></span><span style="color:#f92672">-   for y in range(game_map.height):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   if fov_recompute:
</span><span style="color:#a6e22e"></span><span style="color:#f92672">-       for x in range(game_map.width):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       for y in range(game_map.height):
</span><span style="color:#a6e22e"></span><span style="color:#f92672">-           wall = game_map.tiles[x][y].block_sight
</span><span style="color:#f92672">-
</span><span style="color:#f92672">-           if wall:
</span><span style="color:#f92672">-               libtcod.console_set_char_background(con, x, y, colors.get(&#39;dark_wall&#39;), libtcod.BKGND_SET)
</span><span style="color:#f92672">-           else:
</span><span style="color:#f92672">-               libtcod.console_set_char_background(con, x, y, colors.get(&#39;dark_ground&#39;), libtcod.BKGND_SET)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+           for x in range(game_map.width):
</span><span style="color:#a6e22e">+               visible = libtcod.map_is_in_fov(fov_map, x, y)
</span><span style="color:#a6e22e">+               wall = game_map.tiles[x][y].block_sight
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+               if visible:
</span><span style="color:#a6e22e">+                   if wall:
</span><span style="color:#a6e22e">+                       libtcod.console_set_char_background(con, x, y, colors.get(&#39;light_wall&#39;), libtcod.BKGND_SET)
</span><span style="color:#a6e22e">+                   else:
</span><span style="color:#a6e22e">+                       libtcod.console_set_char_background(con, x, y, colors.get(&#39;light_ground&#39;), libtcod.BKGND_SET)
</span><span style="color:#a6e22e">+               else:
</span><span style="color:#a6e22e">+                   if wall:
</span><span style="color:#a6e22e">+                       libtcod.console_set_char_background(con, x, y, colors.get(&#39;dark_wall&#39;), libtcod.BKGND_SET)
</span><span style="color:#a6e22e">+                   else:
</span><span style="color:#a6e22e">+                       libtcod.console_set_char_background(con, x, y, colors.get(&#39;dark_ground&#39;), libtcod.BKGND_SET)
</span><span style="color:#a6e22e"></span>
    # Draw all entities in the list
    for entity in entities:
        draw_entity(con, entity)

    libtcod.console_blit(con, 0, 0, screen_width, screen_height, 0, 0, 0)
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre><span class="crossed-out-text">def render_all(con, entities, game_map, screen_width, screen_height, colors):</span>
<span class="new-text">def render_all(con, entities, game_map, fov_map, fov_recompute, screen_width, screen_height, colors):</span>
    <span class="new-text">if fov_recompute:</span>
        <span style="color: blue">for y in range(game_map.height):
            for x in range(game_map.width):</span>
                <span class="new-text">visible = libtcod.map_is_in_fov(fov_map, x, y)</span>
                <span style="color: blue">wall = game_map.tiles[x][y].block_sight</span>

                <span class="new-text">if visible:
                    if wall:
                        libtcod.console_set_char_background(con, x, y, colors.get('light_wall'), libtcod.BKGND_SET)
                    else:
                        libtcod.console_set_char_background(con, x, y, colors.get('light_ground'), libtcod.BKGND_SET)
                else:</span>
                    <span style="color: blue">if wall:
                        libtcod.console_set_char_background(con, x, y, colors.get('dark_wall'), libtcod.BKGND_SET)
                    else:
                        libtcod.console_set_char_background(con, x, y, colors.get('dark_ground'), libtcod.BKGND_SET)</span>

    # Draw all entities in the list
    for entity in entities:
        draw_entity(con, entity)

    libtcod.console_blit(con, 0, 0, screen_width, screen_height, 0, 0, 0)</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p><em>* Note: Blue denotes lines that are exactly the same as before, expect
for their indentation. The if statements for <code>fov_recompute</code> and
<code>visible</code> force certain lines to be indented farther than they were
before. Remember, this is Python, indentation matters!</em></p>
<p>Now our <code>render_all</code> function will display tiles differently, depending
on if they&rsquo;re in our field of view or not. If a tile falls in the
<code>fov_map</code>, we draw it with the &lsquo;light&rsquo; colors, and if not, we draw the
&lsquo;dark&rsquo; version.</p>
<p>The definition of <code>render_all</code> has changed, so be sure to update it in
<code>engine.py</code>. While we&rsquo;re at it, let&rsquo;s set <code>fov_recompute</code> to <code>False</code>
after we call <code>render_all</code>.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
<span style="color:#f92672">-       render_all(con, entities, game_map, screen_width, screen_height, colors)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       render_all(con, entities, game_map, fov_map, fov_recompute, screen_width, screen_height, colors)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+       fov_recompute = False
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        <span class="crossed-out-text">render_all(con, entities, game_map, screen_width, screen_height, colors)</span>
        <span class="new-text">render_all(con, entities, game_map, fov_map, fov_recompute, screen_width, screen_height, colors)

        fov_recompute = False</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Run the project now. The player&rsquo;s field of view is now visible! But,
despite being able to &ldquo;see&rdquo; the FOV, it still doesn&rsquo;t really <em>do</em>
anything. We can still see the entire map, along with our NPC. Luckily,
the changes we have to make to fix this are fairly minimal.</p>
<p>Let&rsquo;s start with our NPC. We should just be able to modify our
<code>draw_entity</code> function to account for the field of view, which would
solve our problem.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def draw_entity(con, entity):
<span style="color:#a6e22e">+def draw_entity(con, entity, fov_map):
</span><span style="color:#a6e22e"></span><span style="color:#f92672">-   libtcod.console_set_default_foreground(con, entity.color)
</span><span style="color:#f92672">-   libtcod.console_put_char(con, entity.x, entity.y, entity.char, libtcod.BKGND_NONE)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   if libtcod.map_is_in_fov(fov_map, entity.x, entity.y):
</span><span style="color:#a6e22e">+       libtcod.console_set_default_foreground(con, entity.color)
</span><span style="color:#a6e22e">+       libtcod.console_put_char(con, entity.x, entity.y, entity.char, libtcod.BKGND_NONE)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre><span class="crossed-out-text">def draw_entity(con, entity):</span>
<span class="new-text">def draw_entity(con, entity, fov_map):
    if libtcod.map_is_in_fov(fov_map, entity.x, entity.y):</span>
        <span style="color: blue">libtcod.console_set_default_foreground(con, entity.color)
        libtcod.console_put_char(con, entity.x, entity.y, entity.char, libtcod.BKGND_NONE)</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p><em>* Again, the blue means the line is the same as before, except the
indentation has changed.</em></p>
<p>Also be sure to update the part where we call the function:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    for entity in entities:
<span style="color:#f92672">-       draw_entity(con, entity)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       draw_entity(con, entity, fov_map)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    for entity in entities:
        <span class="crossed-out-text">draw_entity(con, entity)</span>
        <span class="new-text">draw_entity(con, entity, fov_map)</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Run the project again, and you won&rsquo;t see the NPC unless it&rsquo;s in your
field of view.</p>
<p>Now for the map. In traditional roguelikes, your character can only see
whats inside its field of view, but it will &ldquo;remember&rdquo; areas that were
explored previously. We can accomplish this effect by adding a variable
called <code>explored</code> to our <code>Tile</code> class. Modify the <code>__init__</code> function in
<code>Tile</code> to include this new variable:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        self.block_sight = block_sight

<span style="color:#a6e22e">+       self.explored = False
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        self.block_sight = block_sight

        <span class="new-text">self.explored = False</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>This new variable needs to be taken into account in our <code>render_all</code>
function. Let&rsquo;s do that now. We&rsquo;ll only draw the tiles outside of our
field of view if we&rsquo;ve explored them previously. Also, any tiles that
<em>are</em> in our field of view, we&rsquo;ll mark as &lsquo;explored&rsquo;.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">                ...
                visible = libtcod.map_is_in_fov(fov_map, x, y)
                wall = game_map.tiles[x][y].block_sight

                if visible:
                    if wall:
                        libtcod.console_set_char_background(con, x, y, colors.get(&#39;light_wall&#39;), libtcod.BKGND_SET)
                    else:
                        libtcod.console_set_char_background(con, x, y, colors.get(&#39;light_ground&#39;), libtcod.BKGND_SET)

<span style="color:#a6e22e">+                   game_map.tiles[x][y].explored = True
</span><span style="color:#a6e22e"></span><span style="color:#f92672">-               else:
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+               elif game_map.tiles[x][y].explored:
</span><span style="color:#a6e22e"></span>                    if wall:
                        libtcod.console_set_char_background(con, x, y, colors.get(&#39;dark_wall&#39;), libtcod.BKGND_SET)
                    else:
                        libtcod.console_set_char_background(con, x, y, colors.get(&#39;dark_ground&#39;), libtcod.BKGND_SET)
                    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>                ...
                visible = libtcod.map_is_in_fov(fov_map, x, y)
                wall = game_map.tiles[x][y].block_sight

                if visible:
                    if wall:
                        libtcod.console_set_char_background(con, x, y, colors.get('light_wall'), libtcod.BKGND_SET)
                    else:
                        libtcod.console_set_char_background(con, x, y, colors.get('light_ground'), libtcod.BKGND_SET)

                    <span class="new-text">game_map.tiles[x][y].explored = True</span>
                <span class="crossed-out-text">else:</span>
                <span class="new-text">elif game_map.tiles[x][y].explored:</span>
                    if wall:
                        libtcod.console_set_char_background(con, x, y, colors.get('dark_wall'), libtcod.BKGND_SET)
                    else:
                        libtcod.console_set_char_background(con, x, y, colors.get('dark_ground'), libtcod.BKGND_SET)
                    ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>We now have a real, explorable dungeon! True, there may not be much
<em>in</em> there right now, but this was a major step to a working game. In
the next few parts, we&rsquo;ll fill the dungeon with some evil(?) monsters to
punch.</p>
<p>If you want to see the code so far in its entirety, <a href="https://github.com/TStand90/roguelike_tutorial_revised/tree/part4">click
here</a>.</p>
<p><a href="/tutorials/tcod/2019/part-5">Click here to move on to the next part of this
tutorial.</a></p>
<!-- raw HTML omitted -->


    

    


</article>



        </div>

        <aside class="col-12 col-lg-3 ml-auto blog-sidebar">
    
    
        <section>
    
        
    
        
    
</section>
    
</aside>

      </div>
    </div>
    

    
      







<footer class="blog-footer w-100">
    <nav class="navbar navbar-light bg-light">
        <p class="w-100 text-center">Last updated July 7th, 2020</p>
        <p class="w-100 text-center"><a href="#">Back to top</a></p>
    </nav>
</footer>

    

    
    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  </body>
</html>
