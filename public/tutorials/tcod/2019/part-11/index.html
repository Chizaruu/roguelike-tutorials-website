<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Part 11 - Delving into the Dungeon" />
<meta property="og:description" content="Our game isn&rsquo;t much of a &ldquo;dungeon crawler&rdquo; if there&rsquo;s only one floor to our dungeon. In this chapter, we&rsquo;ll allow the player to go down a level, and we&rsquo;ll put a very basic leveling up system in place, to make the dive all the more rewarding.
Let&rsquo;s start by modifying the GameMap to hold the current dungeon depth. This will help out when we&rsquo;re writing our stairs. Open game_map and make the following modification:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://rogueliketutorials.com/tutorials/tcod/2019/part-11/" /><meta property="article:section" content="tutorials" />
<meta property="article:published_time" content="2019-03-30T09:34:06-07:00" />
<meta property="article:modified_time" content="2019-03-30T09:34:06-07:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Part 11 - Delving into the Dungeon"/>
<meta name="twitter:description" content="Our game isn&rsquo;t much of a &ldquo;dungeon crawler&rdquo; if there&rsquo;s only one floor to our dungeon. In this chapter, we&rsquo;ll allow the player to go down a level, and we&rsquo;ll put a very basic leveling up system in place, to make the dive all the more rewarding.
Let&rsquo;s start by modifying the GameMap to hold the current dungeon depth. This will help out when we&rsquo;re writing our stairs. Open game_map and make the following modification:"/>



    <link rel="canonical" href="https://rogueliketutorials.com/tutorials/tcod/2019/part-11/">

    <title>
      
        Part 11 - Delving into the Dungeon | Roguelike Tutorials
      
    </title>

    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="https://rogueliketutorials.com/css/style.css" rel="stylesheet">

    

    

    
  </head>
  <body>
    
      

<header class="blog-header">
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <a class="navbar-brand" href="/">
            Roguelike Tutorials
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
            <ul class="navbar-nav">
                
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/">Home</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/tutorials/tcod/2019/">TCOD Tutorial (2019)</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/tutorials/tcod/v2/">TCOD Tutorial (2020)</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/about/">About</a>
                    
                </li>
                
            </ul>
            
        </div>
    </nav>
</header>

    

    
    <div class="container">
      <div class="row">
        <div class="col-12 col-lg-8 blog-main">

          

<header>
    <h2 class="blog-post-title">
    <a class="text-dark" href="/tutorials/tcod/2019/part-11/">Part 11 - Delving into the Dungeon</a>
</h2>

    


<div class="blog-post-date text-secondary">
    
        <time datetime="2019-03-30">Mar 30, 2019</time>
    
    
</div>

    
    
    <hr>
</header>
<article class="blog-post">
    <p>Our game isn&rsquo;t much of a &ldquo;dungeon crawler&rdquo; if there&rsquo;s only one floor to
our dungeon. In this chapter, we&rsquo;ll allow the player to go down a level,
and we&rsquo;ll put a very basic leveling up system in place, to make the dive
all the more rewarding.</p>
<p>Let&rsquo;s start by modifying the <code>GameMap</code> to hold the current dungeon
depth. This will help out when we&rsquo;re writing our stairs. Open <code>game_map</code>
and make the following modification:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class GameMap:
<span style="color:#f92672">-   def __init__(self, width, height):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   def __init__(self, width, height, dungeon_level=1):
</span><span style="color:#a6e22e"></span>        self.width = width
        self.height = height
        self.tiles = self.initialize_tiles()

<span style="color:#a6e22e">+       self.dungeon_level = dungeon_level
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class GameMap:
    def __init__(self, width, height<span class="new-text">, dungeon_level=1</span>):
        self.width = width
        self.height = height
        self.tiles = self.initialize_tiles()

        <span class="new-text">self.dungeon_level = dungeon_level</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>The stairs themselves will be another <code>Entity</code>, as you might expect.
We&rsquo;ll create a new component that sets it apart from the rest, called
<code>Stairs</code>. Create a file called <code>stairs.py</code> and put the following class
in it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stairs</span>:
    <span style="color:#66d9ef">def</span> __init__(self, floor):
        self<span style="color:#f92672">.</span>floor <span style="color:#f92672">=</span> floor</code></pre></div>
<p>The <code>floor</code> variable tells us which floor we&rsquo;ll be landing on if we take
the stairs. Our game will only allow for downward movement, but you
could use this to represent going up a floor as well.</p>
<p>Like with all our other components, we need to pass it into <code>Entity</code>.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class Entity:
    def __init__(self, x, y, char, color, name, blocks=False, render_order=RenderOrder.CORPSE, fighter=None, ai=None,
<span style="color:#f92672">-                item=None, inventory=None):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+                item=None, inventory=None, stairs=None):
</span><span style="color:#a6e22e"></span>        self.x = x
        self.y = y
        self.char = char
        self.color = color
        self.name = name
        self.blocks = blocks
        self.render_order = render_order
        self.fighter = fighter
        self.ai = ai
        self.item = item
        self.inventory = inventory
<span style="color:#a6e22e">+       self.stairs = stairs
</span><span style="color:#a6e22e"></span>
        if self.fighter:
            self.fighter.owner = self

        if self.ai:
            self.ai.owner = self

        if self.item:
            self.item.owner = self

        if self.inventory:
            self.inventory.owner = self

<span style="color:#a6e22e">+       if self.stairs:
</span><span style="color:#a6e22e">+           self.stairs.owner = self
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class Entity:
    def __init__(self, x, y, char, color, name, blocks=False, render_order=RenderOrder.CORPSE, fighter=None, ai=None,
                 item=None, inventory=None<span class="new-text">, stairs=None</span>):
        self.x = x
        self.y = y
        self.char = char
        self.color = color
        self.name = name
        self.blocks = blocks
        self.render_order = render_order
        self.fighter = fighter
        self.ai = ai
        self.item = item
        self.inventory = inventory
        <span class="new-text">self.stairs = stairs</span>

        if self.fighter:
            self.fighter.owner = self

        if self.ai:
            self.ai.owner = self

        if self.item:
            self.item.owner = self

        if self.inventory:
            self.inventory.owner = self

        <span class="new-text">if self.stairs:
            self.stairs.owner = self</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>For placing our stairs, we&rsquo;ll turn to our <code>make_map</code> function. To keep
things simple, we&rsquo;ll always place the stairs in the middle of the last
room we create. Modify the function like
this:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    def make_map(self, max_rooms, room_min_size, room_max_size, map_width, map_height, player, entities,
                 max_monsters_per_room, max_items_per_room):
        rooms = []
        num_rooms = 0

<span style="color:#a6e22e">+       center_of_last_room_x = None
</span><span style="color:#a6e22e">+       center_of_last_room_y = None
</span><span style="color:#a6e22e"></span>
        for r in range(max_rooms):
            # random width and height
            w = randint(room_min_size, room_max_size)
            h = randint(room_min_size, room_max_size)
            # random position without going out of the boundaries of the map
            x = randint(0, map_width - w - 1)
            y = randint(0, map_height - h - 1)

            # &#34;Rect&#34; class makes rectangles easier to work with
            new_room = Rect(x, y, w, h)

            # run through the other rooms and see if they intersect with this one
            for other_room in rooms:
                if new_room.intersect(other_room):
                    break
            else:
                # this means there are no intersections, so this room is valid

                # &#34;paint&#34; it to the map&#39;s tiles
                self.create_room(new_room)

                # center coordinates of new room, will be useful later
                (new_x, new_y) = new_room.center()

<span style="color:#a6e22e">+               center_of_last_room_x = new_x
</span><span style="color:#a6e22e">+               center_of_last_room_y = new_y
</span><span style="color:#a6e22e"></span>
                if num_rooms == 0:
                    # this is the first room, where the player starts at
                    player.x = new_x
                    player.y = new_y
                else:
                    # all rooms after the first:
                    # connect it to the previous room with a tunnel

                    # center coordinates of previous room
                    (prev_x, prev_y) = rooms[num_rooms - 1].center()

                    # flip a coin (random number that is either 0 or 1)
                    if randint(0, 1) == 1:
                        # first move horizontally, then vertically
                        self.create_h_tunnel(prev_x, new_x, prev_y)
                        self.create_v_tunnel(prev_y, new_y, new_x)
                    else:
                        # first move vertically, then horizontally
                        self.create_v_tunnel(prev_y, new_y, prev_x)
                        self.create_h_tunnel(prev_x, new_x, new_y)

                self.place_entities(new_room, entities, max_monsters_per_room, max_items_per_room)

                # finally, append the new room to the list
                rooms.append(new_room)
                num_rooms += 1

<span style="color:#a6e22e">+       stairs_component = Stairs(self.dungeon_level + 1)
</span><span style="color:#a6e22e">+       down_stairs = Entity(center_of_last_room_x, center_of_last_room_y, &#39;&gt;&#39;, libtcod.white, &#39;Stairs&#39;,
</span><span style="color:#a6e22e">+                            render_order=RenderOrder.STAIRS, stairs=stairs_component)
</span><span style="color:#a6e22e">+       entities.append(down_stairs)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    def make_map(self, max_rooms, room_min_size, room_max_size, map_width, map_height, player, entities,
                 max_monsters_per_room, max_items_per_room):
        rooms = []
        num_rooms = 0

        <span class="new-text">center_of_last_room_x = None
        center_of_last_room_y = None</span>

        for r in range(max_rooms):
            # random width and height
            w = randint(room_min_size, room_max_size)
            h = randint(room_min_size, room_max_size)
            # random position without going out of the boundaries of the map
            x = randint(0, map_width - w - 1)
            y = randint(0, map_height - h - 1)

            # "Rect" class makes rectangles easier to work with
            new_room = Rect(x, y, w, h)

            # run through the other rooms and see if they intersect with this one
            for other_room in rooms:
                if new_room.intersect(other_room):
                    break
            else:
                # this means there are no intersections, so this room is valid

                # "paint" it to the map's tiles
                self.create_room(new_room)

                # center coordinates of new room, will be useful later
                (new_x, new_y) = new_room.center()

                <span class="new-text">center_of_last_room_x = new_x
                center_of_last_room_y = new_y</span>

                if num_rooms == 0:
                    # this is the first room, where the player starts at
                    player.x = new_x
                    player.y = new_y
                else:
                    # all rooms after the first:
                    # connect it to the previous room with a tunnel

                    # center coordinates of previous room
                    (prev_x, prev_y) = rooms[num_rooms - 1].center()

                    # flip a coin (random number that is either 0 or 1)
                    if randint(0, 1) == 1:
                        # first move horizontally, then vertically
                        self.create_h_tunnel(prev_x, new_x, prev_y)
                        self.create_v_tunnel(prev_y, new_y, new_x)
                    else:
                        # first move vertically, then horizontally
                        self.create_v_tunnel(prev_y, new_y, prev_x)
                        self.create_h_tunnel(prev_x, new_x, new_y)

                self.place_entities(new_room, entities, max_monsters_per_room, max_items_per_room)

                # finally, append the new room to the list
                rooms.append(new_room)
                num_rooms += 1

        <span class="new-text">stairs_component = Stairs(self.dungeon_level + 1)
        down_stairs = Entity(center_of_last_room_x, center_of_last_room_y, '>', libtcod.white, 'Stairs',
                             render_order=RenderOrder.STAIRS, stairs=stairs_component)
        entities.append(down_stairs)</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Be sure to import <code>Stairs</code> at the top.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">...
from components.ai import BasicMonster
from components.fighter import Fighter
from components.item import Item
<span style="color:#a6e22e">+from components.stairs import Stairs
</span><span style="color:#a6e22e"></span>...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>...
from components.ai import BasicMonster
from components.fighter import Fighter
from components.item import Item
<span class="new-text">from components.stairs import Stairs</span>
...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>We&rsquo;re creating two new variables to keep track of the last room&rsquo;s center
x and y, and using them to place our stairs. The stairs themselves are
just a tuple that holds the x and y coordinates.</p>
<p>Notice that we used a new value in the <code>RenderOrder</code> enum in the code
above. We&rsquo;ll need to add that to <code>RenderOrder</code>. The stairs should appear
below everything else, so it will be the first value in our enum; the
others will have to be pushed down.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class RenderOrder(Enum):
<span style="color:#a6e22e">+   STAIRS = 1
</span><span style="color:#a6e22e"></span><span style="color:#f92672">-   CORPSE = 1
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   CORPSE = 2
</span><span style="color:#a6e22e"></span><span style="color:#f92672">-   ITEM = 2
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   ITEM = 3
</span><span style="color:#a6e22e"></span><span style="color:#f92672">-   ACTOR = 3
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   ACTOR = 4
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class RenderOrder(Enum):
    <span class="new-text">STAIRS = 1</span>
    <span class="crossed-out-text">CORPSE = 1</span>
    <span class="new-text">CORPSE = 2</span>
    <span class="crossed-out-text">ITEM = 2</span>
    <span class="new-text">ITEM = 3</span>
    <span class="crossed-out-text">ACTOR = 3</span>
    <span class="new-text">ACTOR = 4</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Note that if you&rsquo;re working on Python 3.6, you can make this a lot
easier with the <code>auto()</code> function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RenderOrder</span>(Enum):
    STAIRS <span style="color:#f92672">=</span> auto()
    CORPSE <span style="color:#f92672">=</span> auto()
    ITEM <span style="color:#f92672">=</span> auto()
    ACTOR <span style="color:#f92672">=</span> auto()</code></pre></div>
<p>One problem with our current implementation is that we can only see the
stairs when they&rsquo;re in the player&rsquo;s field of view. This might sound
right at first, but consider if the player has seen the stairs, and then
moves away from them. The stairs won&rsquo;t show on the map! It&rsquo;d be better
if once found, the stairs are always drawn.</p>
<p>To make this happen, we can modify the <code>draw_entity</code> function inside
<code>render_functions</code>.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">-def draw_entity(con, entity, fov_map):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+def draw_entity(con, entity, fov_map, game_map):
</span><span style="color:#a6e22e"></span><span style="color:#f92672">-   if libtcod.map_is_in_fov(fov_map, entity.x, entity.y):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   if libtcod.map_is_in_fov(fov_map, entity.x, entity.y) or (entity.stairs and game_map.tiles[entity.x][entity.y].explored):
</span><span style="color:#a6e22e"></span>        libtcod.console_set_default_foreground(con, entity.color)
        libtcod.console_put_char(con, entity.x, entity.y, entity.char, libtcod.BKGND_NONE)
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre><span class="crossed-out-text">def draw_entity(con, entity, fov_map):</span>
<span class="new-text">def draw_entity(con, entity, fov_map, game_map):</span>
    <span class="crossed-out-text">if libtcod.map_is_in_fov(fov_map, entity.x, entity.y):</span>
    <span class="new-text">if libtcod.map_is_in_fov(fov_map, entity.x, entity.y) or (entity.stairs and game_map.tiles[entity.x][entity.y].explored):</span>
        libtcod.console_set_default_foreground(con, entity.color)
        libtcod.console_put_char(con, entity.x, entity.y, entity.char, libtcod.BKGND_NONE)</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>We&rsquo;re now checking if the entity has the &lsquo;stairs&rsquo; component, and if the
map has been explored. If so, we draw the entity, regardless if it&rsquo;s in
the field of view or not. This works even if there&rsquo;s another entity on
top of the stairs.</p>
<p>Note that we&rsquo;re now passing the <code>game_map</code> object to <code>draw_entity</code>.
We&rsquo;ll need to update our call to <code>draw_entity</code> in <code>render_all</code>.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    for entity in entities_in_render_order:
<span style="color:#f92672">-       draw_entity(con, entity, fov_map)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       draw_entity(con, entity, fov_map, game_map)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    for entity in entities_in_render_order:
        draw_entity(con, entity, fov_map<span class="new-text">, game_map</span>)</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Run the project now, and you should be able to see the stairs (if you
can find them before meeting your end!). Now let&rsquo;s make them do
something.</p>
<p>First, let&rsquo;s add a handler for going down the stairs in
<code>input_handlers.py</code>. Add the following to the <code>handle_player_turn_keys</code>
function:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    elif key_char == &#39;d&#39;:
        return {&#39;drop_inventory&#39;: True}

<span style="color:#a6e22e">+   elif key.vk == libtcod.KEY_ENTER:
</span><span style="color:#a6e22e">+       return {&#39;take_stairs&#39;: True}
</span><span style="color:#a6e22e"></span>
    if key.vk == libtcod.KEY_ENTER and key.lalt:
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    elif key_char == 'd':
        return {'drop_inventory': True}

    <span class="new-text">elif key.vk == libtcod.KEY_ENTER:
        return {'take_stairs': True}</span>

    if key.vk == libtcod.KEY_ENTER and key.lalt:
        ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p><em>*Note: I&rsquo;ve used the Enter key here rather than the traditional &lsquo;&gt;&rsquo;
key. This is because the current Roguebasin tutorial&rsquo;s code for the &lsquo;&gt;&rsquo;
key does not work.</em></p>
<p>With all this in place, we&rsquo;ll need to implement the code to actually
move the player down a floor. To go down a floor, we&rsquo;ll need to generate
a new map, create a new list of entities, and increment the integer that
represents the dungeon floor. It&rsquo;s not nearly as complex as it sounds!
Things get a little more difficult if you want to allow the player to
move back up the stairs, but in order to keep this tutorial as simple as
possible, we&rsquo;ll say that once you descend down to the next floor, you
cannot go back up.</p>
<p>Now let&rsquo;s write the function that will take us down a floor. Add the
following to the bottom of the <code>game_map.py</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3">    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">next_floor</span>(self, player, message_log, constants):
        self<span style="color:#f92672">.</span>dungeon_level <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        entities <span style="color:#f92672">=</span> [player]

        self<span style="color:#f92672">.</span>tiles <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>initialize_tiles()
        self<span style="color:#f92672">.</span>make_map(constants[<span style="color:#e6db74">&#39;max_rooms&#39;</span>], constants[<span style="color:#e6db74">&#39;room_min_size&#39;</span>], constants[<span style="color:#e6db74">&#39;room_max_size&#39;</span>],
                      constants[<span style="color:#e6db74">&#39;map_width&#39;</span>], constants[<span style="color:#e6db74">&#39;map_height&#39;</span>], player, entities,
                      constants[<span style="color:#e6db74">&#39;max_monsters_per_room&#39;</span>], constants[<span style="color:#e6db74">&#39;max_items_per_room&#39;</span>])

        player<span style="color:#f92672">.</span>fighter<span style="color:#f92672">.</span>heal(player<span style="color:#f92672">.</span>fighter<span style="color:#f92672">.</span>max_hp <span style="color:#f92672">//</span> <span style="color:#ae81ff">2</span>)

        message_log<span style="color:#f92672">.</span>add_message(Message(<span style="color:#e6db74">&#39;You take a moment to rest, and recover your strength.&#39;</span>, libtcod<span style="color:#f92672">.</span>light_violet))

        <span style="color:#66d9ef">return</span> entities</code></pre></div>
<p>The function starts by incrementing the dungeon level by one. The
<code>entities</code> list is created from scratch, with only the player in it
initially. We then call <code>make_map</code> to generate the new floor, like we
did at the game&rsquo;s start. We&rsquo;ll also give the player half of the max HP
back, as a reward for making it to the new floor, and add a message to
this effect. We then return the <code>entities</code> list to be used in
<code>engine.py</code>.</p>
<p>At last, let&rsquo;s modify <code>engine.py</code> to use this new function.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        inventory_index = action.get(&#39;inventory_index&#39;)
<span style="color:#a6e22e">+       take_stairs = action.get(&#39;take_stairs&#39;)
</span><span style="color:#a6e22e"></span>        exit = action.get(&#39;exit&#39;)
        ...
        if inventory_index is not None and previous_game_state != GameStates.PLAYER_DEAD and inventory_index &lt; len(
            ...

<span style="color:#a6e22e">+       if take_stairs and game_state == GameStates.PLAYERS_TURN:
</span><span style="color:#a6e22e">+           for entity in entities:
</span><span style="color:#a6e22e">+               if entity.stairs and entity.x == player.x and entity.y == player.y:
</span><span style="color:#a6e22e">+                   entities = game_map.next_floor(player, message_log, constants)
</span><span style="color:#a6e22e">+                   fov_map = initialize_fov(game_map)
</span><span style="color:#a6e22e">+                   fov_recompute = True
</span><span style="color:#a6e22e">+                   libtcod.console_clear(con)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+                   break
</span><span style="color:#a6e22e">+           else:
</span><span style="color:#a6e22e">+               message_log.add_message(Message(&#39;There are no stairs here.&#39;, libtcod.yellow))
</span><span style="color:#a6e22e"></span>
        if game_state == GameStates.TARGETING:
            ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>
        ...
        inventory_index = action.get('inventory_index')
        <span class="new-text">take_stairs = action.get('take_stairs')</span>
        exit = action.get('exit')
        ...
        if inventory_index is not None and previous_game_state != GameStates.PLAYER_DEAD and inventory_index < len(
            ...

        <span class="new-text">if take_stairs and game_state == GameStates.PLAYERS_TURN:
            for entity in entities:
                if entity.stairs and entity.x == player.x and entity.y == player.y:
                    entities = game_map.next_floor(player, message_log, constants)
                    fov_map = initialize_fov(game_map)
                    fov_recompute = True
                    libtcod.console_clear(con)

                    break
            else:
                message_log.add_message(Message('There are no stairs here.', libtcod.yellow))</span>

        if game_state == GameStates.TARGETING:
            ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>If the player is standing on the stairs, we call the <code>next_floor</code>
function and set the <code>entities</code> list to the new values. We also clear
the screen, so that the map shows as unexplored once again, and set the
FOV to recompute. If there aren&rsquo;t any stairs, we let the player know.</p>
<p>We can easily display the dungeon&rsquo;s current depth right below the HP
bar, by rendering the <code>render_all</code> function like so:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    render_bar(panel, 1, 1, bar_width, &#39;HP&#39;, player.fighter.hp, player.fighter.max_hp,
               libtcod.light_red, libtcod.darker_red)
<span style="color:#a6e22e">+   libtcod.console_print_ex(panel, 1, 3, libtcod.BKGND_NONE, libtcod.LEFT,
</span><span style="color:#a6e22e">+                            &#39;Dungeon level: {0}&#39;.format(game_map.dungeon_level))
</span><span style="color:#a6e22e"></span>
    libtcod.console_set_default_foreground(panel, libtcod.light_gray)
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>
    ...
    render_bar(panel, 1, 1, bar_width, 'HP', player.fighter.hp, player.fighter.max_hp,
               libtcod.light_red, libtcod.darker_red)
    <span class="new-text">libtcod.console_print_ex(panel, 1, 3, libtcod.BKGND_NONE, libtcod.LEFT,
                             'Dungeon level: {0}'.format(game_map.dungeon_level))</span>

    libtcod.console_set_default_foreground(panel, libtcod.light_gray)
    ...
</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>And that&rsquo;s it! We are now officially dungeon diving! However, the way
our game works right now, going deeper into the dungeon isn&rsquo;t
particularly interesting. In order to make it feel more like a
roguelike, we&rsquo;ll need to do two things: give our character some sort of
progression (either through leveling up or better equipment) and make
the monsters more threatening at lower levels. We&rsquo;ll focus on the former
for the remainder of this chapter, while the latter will be for the next
one.</p>
<p>Most roguelikes (and RPGs in general) reward the player with experience
points upon killing an opponent. Once a certain amount of experience has
been collected, the player levels up and gets stronger. In order to
achieve that, we&rsquo;ll need to do several things. Let&rsquo;s start by modifying
the <code>Fighter</code> component to hold a new variable: <code>xp</code>. This will
represent the experience points the player receives upon killing an
enemy (but not the experience points of the Entity itself, more on that
later).</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class Fighter:
<span style="color:#f92672">-   def __init__(self, hp, defense, power):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   def __init__(self, hp, defense, power, xp=0):
</span><span style="color:#a6e22e"></span>        self.max_hp = hp
        self.hp = hp
        self.defense = defense
        self.power = power
<span style="color:#a6e22e">+       self.xp = xp
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class Fighter:
    def __init__(self, hp, defense, power<span class="new-text">, xp=0</span>):
        self.max_hp = hp
        self.hp = hp
        self.defense = defense
        self.power = power
        <span class="new-text">self.xp = xp</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>We don&rsquo;t need to modify the player&rsquo;s fighter component at all, but we&rsquo;ll
need to alter the components for our enemies. Open up <code>game_map.py</code> and
modify the <code>place_entities</code> function to include experience points in
each fighter component.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">                ...
                if randint(0, 100) &lt; 80:
<span style="color:#f92672">-                   fighter_component = Fighter(hp=10, defense=0, power=3)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+                   fighter_component = Fighter(hp=10, defense=0, power=3, xp=35)
</span><span style="color:#a6e22e"></span>                    ai_component = BasicMonster()

                    monster = Entity(x, y, &#39;o&#39;, libtcod.desaturated_green, &#39;Orc&#39;, blocks=True,
                                     render_order=RenderOrder.ACTOR, fighter=fighter_component, ai=ai_component)
                else:
<span style="color:#f92672">-                   fighter_component = Fighter(hp=16, defense=1, power=4)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+                   fighter_component = Fighter(hp=16, defense=1, power=4, xp=100)
</span><span style="color:#a6e22e"></span>                    ai_component = BasicMonster()

                    monster = Entity(x, y, &#39;T&#39;, libtcod.darker_green, &#39;Troll&#39;, blocks=True, fighter=fighter_component,
                                     render_order=RenderOrder.ACTOR, ai=ai_component)
                ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>                ...
                if randint(0, 100) < 80:
                    fighter_component = Fighter(hp=10, defense=0, power=3<span class="new-text">, xp=35</span>)
                    ai_component = BasicMonster()

                    monster = Entity(x, y, 'o', libtcod.desaturated_green, 'Orc', blocks=True,
                                     render_order=RenderOrder.ACTOR, fighter=fighter_component, ai=ai_component)
                else:
                    fighter_component = Fighter(hp=16, defense=1, power=4<span class="new-text">, xp=100</span>)
                    ai_component = BasicMonster()

                    monster = Entity(x, y, 'T', libtcod.darker_green, 'Troll', blocks=True, fighter=fighter_component,
                                     render_order=RenderOrder.ACTOR, ai=ai_component)
                ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>The player&rsquo;s xp will be a bit different, because we&rsquo;ll be keeping track
of a running total. We&rsquo;ll also need to know how much more experience the
player needs until the next level up. Let&rsquo;s create a new component to
keep track of all this, which we&rsquo;ll call <code>Level</code>. Create a new file in
<code>components</code> called <code>level.py</code> and put the following code in it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Level</span>:
    <span style="color:#66d9ef">def</span> __init__(self, current_level<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, current_xp<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, level_up_base<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span>, level_up_factor<span style="color:#f92672">=</span><span style="color:#ae81ff">150</span>):
        self<span style="color:#f92672">.</span>current_level <span style="color:#f92672">=</span> current_level
        self<span style="color:#f92672">.</span>current_xp <span style="color:#f92672">=</span> current_xp
        self<span style="color:#f92672">.</span>level_up_base <span style="color:#f92672">=</span> level_up_base
        self<span style="color:#f92672">.</span>level_up_factor <span style="color:#f92672">=</span> level_up_factor

    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">experience_to_next_level</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>level_up_base <span style="color:#f92672">+</span> self<span style="color:#f92672">.</span>current_level <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>level_up_factor

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_xp</span>(self, xp):
        self<span style="color:#f92672">.</span>current_xp <span style="color:#f92672">+=</span> xp

        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>current_xp <span style="color:#f92672">&gt;</span> self<span style="color:#f92672">.</span>experience_to_next_level:
            self<span style="color:#f92672">.</span>current_xp <span style="color:#f92672">-=</span> self<span style="color:#f92672">.</span>experience_to_next_level
            self<span style="color:#f92672">.</span>current_level <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span></code></pre></div>
<p>I&rsquo;ve set all the variables in this class to have the defaults I want,
which you should feel free to change. Also, it probably makes more sense
to put these defaults in our <code>constants</code> dictionary, but in the interest
of moving things along faster, I&rsquo;ve put them here.</p>
<p>The <code>current_level</code> is our player&rsquo;s level, which should start at 1,
unless we&rsquo;re loading a saved game. <code>current_xp</code> is a running total of
the player&rsquo;s experience points, which resets when the player levels up.
<code>level_up_base</code> and <code>level_up_factor</code> are using in our level up formula.</p>
<p>When the player gains experience points, we check if the current xp is
greater than the level up base, plus the current level times the level
up factor. This makes it such that leveling up takes a longer time at
higher levels. If it is, then we reset the <code>current_xp</code>, and return
<code>True</code> (which our engine will know means that the player leveled up).</p>
<p>The actual level up threshold is handled by the
<code>experience_to_next_level</code> property. What&rsquo;s a property? It&rsquo;s basically a
read only variable that we can easily access inside the class and on the
objects we create. <code>experience_to_next_level</code> will always have the
latest value when we access it, so we can just say
<code>player.level.experience_to_next_level</code> and get the correct value.</p>
<p>Let&rsquo;s add this new component to the <code>Entity</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class Entity:
    def __init__(self, x, y, char, color, name, blocks=False, render_order=RenderOrder.CORPSE, fighter=None, ai=None,
<span style="color:#f92672">-                item=None, inventory=None, stairs=None):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+                item=None, inventory=None, stairs=None, level=None):
</span><span style="color:#a6e22e"></span>        self.x = x
        self.y = y
        self.char = char
        self.color = color
        self.name = name
        self.blocks = blocks
        self.render_order = render_order
        self.fighter = fighter
        self.ai = ai
        self.item = item
        self.inventory = inventory
        self.stairs = stairs
<span style="color:#a6e22e">+       self.level = level
</span><span style="color:#a6e22e"></span>
        if self.fighter:
            self.fighter.owner = self

        if self.ai:
            self.ai.owner = self

        if self.item:
            self.item.owner = self

        if self.inventory:
            self.inventory.owner = self

        if self.stairs:
            self.stairs.owner = self

<span style="color:#a6e22e">+       if self.level:
</span><span style="color:#a6e22e">+           self.level.owner = self
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class Entity:
    def __init__(self, x, y, char, color, name, blocks=False, render_order=RenderOrder.CORPSE, fighter=None, ai=None,
                 item=None, inventory=None, stairs=None<span class="new-text">, level=None</span>):
        self.x = x
        self.y = y
        self.char = char
        self.color = color
        self.name = name
        self.blocks = blocks
        self.render_order = render_order
        self.fighter = fighter
        self.ai = ai
        self.item = item
        self.inventory = inventory
        self.stairs = stairs
        <span class="new-text">self.level = level</span>

        if self.fighter:
            self.fighter.owner = self

        if self.ai:
            self.ai.owner = self

        if self.item:
            self.item.owner = self

        if self.inventory:
            self.inventory.owner = self

        if self.stairs:
            self.stairs.owner = self

        <span class="new-text">if self.level:
            self.level.owner = self</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Now we&rsquo;ll need to add it to the <code>player</code> object. Open
<code>initialize_new_game.py</code> and make the following modifications:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    fighter_component = Fighter(hp=30, defense=2, power=5)
    inventory_component = Inventory(26)
<span style="color:#a6e22e">+   level_component = Level()
</span><span style="color:#a6e22e"></span>    player = Entity(0, 0, &#39;@&#39;, libtcod.white, &#39;Player&#39;, blocks=True, render_order=RenderOrder.ACTOR,
<span style="color:#f92672">-                   fighter=fighter_component, inventory=inventory_component)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+                   fighter=fighter_component, inventory=inventory_component, level=level_component)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>
    fighter_component = Fighter(hp=30, defense=2, power=5)
    inventory_component = Inventory(26)
    <span class="new-text">level_component = Level()</span>
    player = Entity(0, 0, '@', libtcod.white, 'Player', blocks=True, render_order=RenderOrder.ACTOR,
                    fighter=fighter_component, inventory=inventory_component<span class="new-text">, level=level_component</span>)
</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Remember to import <code>Level</code> at the top:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">from components.fighter import Fighter
from components.inventory import Inventory
<span style="color:#a6e22e">+from components.level import Level
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>
from components.fighter import Fighter
from components.inventory import Inventory
<span class="new-text">from components.level import Level</span>
</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>As is tradition in RPGs, we&rsquo;ll gain this experience when we defeat the
monsters. We can return the xp amount along with our death result, in
the <code>Fighter</code> component&rsquo;s <code>take_damage</code> function.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    def take_damage(self, amount):
        results = []

        self.hp -= amount

        if self.hp &lt;= 0:
<span style="color:#f92672">-           results.append({&#39;dead&#39;: self.owner})
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+           results.append({&#39;dead&#39;: self.owner, &#39;xp&#39;: self.xp})
</span><span style="color:#a6e22e"></span>
        return results
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    def take_damage(self, amount):
        results = []

        self.hp -= amount

        if self.hp <= 0:
            results.append({'dead': self.owner<span class="new-text">, 'xp': self.xp</span>})

        return results</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>And now let&rsquo;s process the result in <code>engine.py</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">            ...
            targeting_cancelled = player_turn_result.get(&#39;targeting_cancelled&#39;)
<span style="color:#a6e22e">+           xp = player_turn_result.get(&#39;xp&#39;)
</span><span style="color:#a6e22e"></span>
            if message:
                ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>            ...
            targeting_cancelled = player_turn_result.get('targeting_cancelled')
            <span class="new-text">xp = player_turn_result.get('xp')</span>

            if message:
                ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">            ...
            if targeting_cancelled:
                ...

<span style="color:#a6e22e">+           if xp:
</span><span style="color:#a6e22e">+               leveled_up = player.level.add_xp(xp)
</span><span style="color:#a6e22e">+               message_log.add_message(Message(&#39;You gain {0} experience points.&#39;.format(xp)))
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+               if leveled_up:
</span><span style="color:#a6e22e">+                   message_log.add_message(Message(
</span><span style="color:#a6e22e">+                       &#39;Your battle skills grow stronger! You reached level {0}&#39;.format(
</span><span style="color:#a6e22e">+                           player.level.current_level) + &#39;!&#39;, libtcod.yellow))
</span><span style="color:#a6e22e">+                   previous_game_state = game_state
</span><span style="color:#a6e22e">+                   game_state = GameStates.LEVEL_UP
</span><span style="color:#a6e22e"></span>
        if game_state == GameStates.ENEMY_TURN:
            ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>            ...
            if targeting_cancelled:
                ...

            <span class="new-text">if xp:
                leveled_up = player.level.add_xp(xp)
                message_log.add_message(Message('You gain {0} experience points.'.format(xp)))

                if leveled_up:
                    message_log.add_message(Message(
                        'Your battle skills grow stronger! You reached level {0}'.format(
                            player.level.current_level) + '!', libtcod.yellow))
                    previous_game_state = game_state
                    game_state = GameStates.LEVEL_UP</span>

        if game_state == GameStates.ENEMY_TURN:
            ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Obviously, we&rsquo;ll need to add the <code>LEVEL_UP</code> game state to our
<code>GameStates</code> enum.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class GameStates(Enum):
    PLAYERS_TURN = 1
    ENEMY_TURN = 2
    PLAYER_DEAD = 3
    SHOW_INVENTORY = 4
    DROP_INVENTORY = 5
    TARGETING = 6
<span style="color:#a6e22e">+   LEVEL_UP = 7
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class GameStates(Enum):
    PLAYERS_TURN = 1
    ENEMY_TURN = 2
    PLAYER_DEAD = 3
    SHOW_INVENTORY = 4
    DROP_INVENTORY = 5
    TARGETING = 6
    <span class="new-text">LEVEL_UP = 7</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>So what happens when the player levels up? Our system will be pretty
simple: the player will have a choice between increasing HP, attack, or
defense. A menu will pop up, prompting the user to select one of these
power ups, and won&rsquo;t close until a selection is made.</p>
<p>Let&rsquo;s create a new menu function, called <code>level_up_menu</code>, which will
display our options:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def main_menu(con, background_image, screen_width, screen_height):
    ...

<span style="color:#a6e22e">+def level_up_menu(con, header, player, menu_width, screen_width, screen_height):
</span><span style="color:#a6e22e">+   options = [&#39;Constitution (+20 HP, from {0})&#39;.format(player.fighter.max_hp),
</span><span style="color:#a6e22e">+              &#39;Strength (+1 attack, from {0})&#39;.format(player.fighter.power),
</span><span style="color:#a6e22e">+              &#39;Agility (+1 defense, from {0})&#39;.format(player.fighter.defense)]
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   menu(con, header, options, menu_width, screen_width, screen_height)
</span><span style="color:#a6e22e"></span>

def message_box(con, header, width, screen_width, screen_height):
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>def main_menu(con, background_image, screen_width, screen_height):
    ...

<span class="new-text">def level_up_menu(con, header, player, menu_width, screen_width, screen_height):
    options = ['Constitution (+20 HP, from {0})'.format(player.fighter.max_hp),
               'Strength (+1 attack, from {0})'.format(player.fighter.power),
               'Agility (+1 defense, from {0})'.format(player.fighter.defense)]

    menu(con, header, options, menu_width, screen_width, screen_height)</span>


def message_box(con, header, width, screen_width, screen_height):
    ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Modify the <code>render_all</code> function to display this menu, after importing
the <code>level_up_menu</code> function.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">import tcod as libtcod

from enum import Enum

from game_states import GameStates

<span style="color:#f92672">-from menus import inventory_menu
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+from menus import inventory_menu, level_up_menu
</span><span style="color:#a6e22e"></span>...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>import tcod as libtcod

from enum import Enum

from game_states import GameStates

from menus import inventory_menu<span class="new-text">, level_up_menu</span>
...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    if game_state in (GameStates.SHOW_INVENTORY, GameStates.DROP_INVENTORY):
        ...

<span style="color:#a6e22e">+   elif game_state == GameStates.LEVEL_UP:
</span><span style="color:#a6e22e">+       level_up_menu(con, &#39;Level up! Choose a stat to raise:&#39;, player, 40, screen_width, screen_height)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>
    if game_state in (GameStates.SHOW_INVENTORY, GameStates.DROP_INVENTORY):
        ...

    <span class="new-text">elif game_state == GameStates.LEVEL_UP:
        level_up_menu(con, 'Level up! Choose a stat to raise:', player, 40, screen_width, screen_height)</span>
</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Of course, we&rsquo;ll need to handle the input for this menu. Open up
<code>input_handlers.py</code> and add the following function:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def handle_main_menu(key):
    ...

<span style="color:#a6e22e">+def handle_level_up_menu(key):
</span><span style="color:#a6e22e">+   if key:
</span><span style="color:#a6e22e">+       key_char = chr(key.c)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+       if key_char == &#39;a&#39;:
</span><span style="color:#a6e22e">+           return {&#39;level_up&#39;: &#39;hp&#39;}
</span><span style="color:#a6e22e">+       elif key_char == &#39;b&#39;:
</span><span style="color:#a6e22e">+           return {&#39;level_up&#39;: &#39;str&#39;}
</span><span style="color:#a6e22e">+       elif key_char == &#39;c&#39;:
</span><span style="color:#a6e22e">+           return {&#39;level_up&#39;: &#39;def&#39;}
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   return {}
</span><span style="color:#a6e22e"></span>

def handle_mouse(mouse):
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>def handle_main_menu(key):
    ...

<span class="new-text">def handle_level_up_menu(key):
    if key:
        key_char = chr(key.c)

        if key_char == 'a':
            return {'level_up': 'hp'}
        elif key_char == 'b':
            return {'level_up': 'str'}
        elif key_char == 'c':
            return {'level_up': 'def'}

    return {}</span>


def handle_mouse(mouse):
    ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Modify the <code>handle_keys</code> function to use this new handler:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def handle_keys(key, game_state):
    if game_state == GameStates.PLAYERS_TURN:
        return handle_player_turn_keys(key)
    elif game_state == GameStates.PLAYER_DEAD:
        return handle_player_dead_keys(key)
    elif game_state == GameStates.TARGETING:
        return handle_targeting_keys(key)
    elif game_state in (GameStates.SHOW_INVENTORY, GameStates.DROP_INVENTORY):
        return handle_inventory_keys(key)
<span style="color:#a6e22e">+   elif game_state == GameStates.LEVEL_UP:
</span><span style="color:#a6e22e">+       return handle_level_up_menu(key)
</span><span style="color:#a6e22e"></span>
    return {}
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>def handle_keys(key, game_state):
    if game_state == GameStates.PLAYERS_TURN:
        return handle_player_turn_keys(key)
    elif game_state == GameStates.PLAYER_DEAD:
        return handle_player_dead_keys(key)
    elif game_state == GameStates.TARGETING:
        return handle_targeting_keys(key)
    elif game_state in (GameStates.SHOW_INVENTORY, GameStates.DROP_INVENTORY):
        return handle_inventory_keys(key)
    <span class="new-text">elif game_state == GameStates.LEVEL_UP:
        return handle_level_up_menu(key)</span>

    return {}</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>With our key handler in place, let&rsquo;s handle the results in <code>engine.py</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        take_stairs = action.get(&#39;take_stairs&#39;)
<span style="color:#a6e22e">+       level_up = action.get(&#39;level_up&#39;)
</span><span style="color:#a6e22e"></span>        exit = action.get(&#39;exit&#39;)
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        take_stairs = action.get('take_stairs')
        <span class="new-text">level_up = action.get('level_up')</span>
        exit = action.get('exit')
        ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        if take_stairs and game_state == GameStates.PLAYERS_TURN:
            ...

<span style="color:#a6e22e">+       if level_up:
</span><span style="color:#a6e22e">+           if level_up == &#39;hp&#39;:
</span><span style="color:#a6e22e">+               player.fighter.max_hp += 20
</span><span style="color:#a6e22e">+               player.fighter.hp += 20
</span><span style="color:#a6e22e">+           elif level_up == &#39;str&#39;:
</span><span style="color:#a6e22e">+               player.fighter.power += 1
</span><span style="color:#a6e22e">+           elif level_up == &#39;def&#39;:
</span><span style="color:#a6e22e">+               player.fighter.defense += 1
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+           game_state = previous_game_state
</span><span style="color:#a6e22e"></span>
        if game_state == GameStates.TARGETING:
            ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        if take_stairs and game_state == GameStates.PLAYERS_TURN:
            ...

        <span class="new-text">if level_up:
            if level_up == 'hp':
                player.fighter.max_hp += 20
                player.fighter.hp += 20
            elif level_up == 'str':
                player.fighter.power += 1
            elif level_up == 'def':
                player.fighter.defense += 1

            game_state = previous_game_state</span>

        if game_state == GameStates.TARGETING:
            ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>In order to help the players keep track of their progress, let&rsquo;s create
a &ldquo;character&rdquo; screen, which displays the player&rsquo;s current stats. This
will require another game state, so let&rsquo;s add that now.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class GameStates(Enum):
    PLAYERS_TURN = 1
    ENEMY_TURN = 2
    PLAYER_DEAD = 3
    SHOW_INVENTORY = 4
    DROP_INVENTORY = 5
    TARGETING = 6
    LEVEL_UP = 7
<span style="color:#a6e22e">+   CHARACTER_SCREEN = 8
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class GameStates(Enum):
    PLAYERS_TURN = 1
    ENEMY_TURN = 2
    PLAYER_DEAD = 3
    SHOW_INVENTORY = 4
    DROP_INVENTORY = 5
    TARGETING = 6
    LEVEL_UP = 7
    <span class="new-text">CHARACTER_SCREEN = 8</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>We should display this screen when the &lsquo;c&rsquo; key is pressed. Let&rsquo;s add the
key to <code>handle_player_turn_keys</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    elif key.vk == libtcod.KEY_ENTER:
        return {&#39;take_stairs&#39;: True}

<span style="color:#a6e22e">+   elif key_char == &#39;c&#39;:
</span><span style="color:#a6e22e">+       return {&#39;show_character_screen&#39;: True}
</span><span style="color:#a6e22e"></span>
    if key.vk == libtcod.KEY_ENTER and key.lalt:
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    elif key.vk == libtcod.KEY_ENTER:
        return {'take_stairs': True}

    <span class="new-text">elif key_char == 'c':
        return {'show_character_screen': True}</span>

    if key.vk == libtcod.KEY_ENTER and key.lalt:
        ...
</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Now let&rsquo;s handle that in <code>engine.py</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        level_up = action.get(&#39;level_up&#39;)
<span style="color:#a6e22e">+       show_character_screen = action.get(&#39;show_character_screen&#39;)
</span><span style="color:#a6e22e"></span>        exit = action.get(&#39;exit&#39;)
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        level_up = action.get('level_up')
        <span class="new-text">show_character_screen = action.get('show_character_screen')</span>
        exit = action.get('exit')
        ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        if level_up:
            ...

<span style="color:#a6e22e">+       if show_character_screen:
</span><span style="color:#a6e22e">+           previous_game_state = game_state
</span><span style="color:#a6e22e">+           game_state = GameStates.CHARACTER_SCREEN
</span><span style="color:#a6e22e"></span>
        if game_state == GameStates.TARGETING:
            ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        if level_up:
            ...

        <span class="new-text">if show_character_screen:
            previous_game_state = game_state
            game_state = GameStates.CHARACTER_SCREEN</span>

        if game_state == GameStates.TARGETING:
            ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Now let&rsquo;s write the input handler for the character screen. All it does
is handles the &lsquo;Escape&rsquo; key, since the character screen isn&rsquo;t
interactive in any way.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def handle_level_up_menu(key):
    ...

<span style="color:#a6e22e">+def handle_character_screen(key):
</span><span style="color:#a6e22e">+   if key.vk == libtcod.KEY_ESCAPE:
</span><span style="color:#a6e22e">+       return {&#39;exit&#39;: True}
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   return {}
</span><span style="color:#a6e22e"></span>

def handle_mouse(mouse):
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>def handle_level_up_menu(key):
    ...

<span class="new-text">def handle_character_screen(key):
    if key.vk == libtcod.KEY_ESCAPE:
        return {'exit': True}

    return {}</span>


def handle_mouse(mouse):
    ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Modify <code>handle_keys</code> to call this function when showing the character
screen:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def handle_keys(key, game_state):
    if game_state == GameStates.PLAYERS_TURN:
        return handle_player_turn_keys(key)
    elif game_state == GameStates.PLAYER_DEAD:
        return handle_player_dead_keys(key)
    elif game_state == GameStates.TARGETING:
        return handle_targeting_keys(key)
    elif game_state in (GameStates.SHOW_INVENTORY, GameStates.DROP_INVENTORY):
        return handle_inventory_keys(key)
    elif game_state == GameStates.LEVEL_UP:
        return handle_level_up_menu(key)
<span style="color:#a6e22e">+   elif game_state == GameStates.CHARACTER_SCREEN:
</span><span style="color:#a6e22e">+       return handle_character_screen(key)
</span><span style="color:#a6e22e"></span>
    return {}
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>def handle_keys(key, game_state):
    if game_state == GameStates.PLAYERS_TURN:
        return handle_player_turn_keys(key)
    elif game_state == GameStates.PLAYER_DEAD:
        return handle_player_dead_keys(key)
    elif game_state == GameStates.TARGETING:
        return handle_targeting_keys(key)
    elif game_state in (GameStates.SHOW_INVENTORY, GameStates.DROP_INVENTORY):
        return handle_inventory_keys(key)
    elif game_state == GameStates.LEVEL_UP:
        return handle_level_up_menu(key)
    <span class="new-text">elif game_state == GameStates.CHARACTER_SCREEN:
        return handle_character_screen(key)</span>

    return {}</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>If the player does press the escape key, we&rsquo;ll just want to revert the
game state. For this, we can extend our current code for &lsquo;exit&rsquo;.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        if exit:
<span style="color:#f92672">-           if game_state in (GameStates.SHOW_INVENTORY, GameStates.DROP_INVENTORY):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+           if game_state in (GameStates.SHOW_INVENTORY, GameStates.DROP_INVENTORY, GameStates.CHARACTER_SCREEN):
</span><span style="color:#a6e22e"></span>                game_state = previous_game_state
            elif game_state == GameStates.TARGETING:
                player_turn_results.append({&#39;targeting_cancelled&#39;: True})
            else:
                save_game(player, entities, game_map, message_log, game_state)

                return True
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        if exit:
            if game_state in (GameStates.SHOW_INVENTORY, GameStates.DROP_INVENTORY<span class="new-text">, GameStates.CHARACTER_SCREEN</span>):
                game_state = previous_game_state
            elif game_state == GameStates.TARGETING:
                player_turn_results.append({'targeting_cancelled': True})
            else:
                save_game(player, entities, game_map, message_log, game_state)

                return True
</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>That takes care of the input handling. Now, to actually display the
screen, we&rsquo;ll need a new menu function. Unlike the other menu functions,
we&rsquo;re not displaying a list of options. Instead, we know up front what
we want to display. Therefore, we can directly print the information to
the screen in a more straightforward fashion. Open <code>menus.py</code> and add
the following
function.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def level_up_menu(con, header, player, menu_width, screen_width, screen_height):
    ...

<span style="color:#a6e22e">+def character_screen(player, character_screen_width, character_screen_height, screen_width, screen_height):
</span><span style="color:#a6e22e">+   window = libtcod.console_new(character_screen_width, character_screen_height)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   libtcod.console_set_default_foreground(window, libtcod.white)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   libtcod.console_print_rect_ex(window, 0, 1, character_screen_width, character_screen_height, libtcod.BKGND_NONE,
</span><span style="color:#a6e22e">+                                 libtcod.LEFT, &#39;Character Information&#39;)
</span><span style="color:#a6e22e">+   libtcod.console_print_rect_ex(window, 0, 2, character_screen_width, character_screen_height, libtcod.BKGND_NONE,
</span><span style="color:#a6e22e">+                                 libtcod.LEFT, &#39;Level: {0}&#39;.format(player.level.current_level))
</span><span style="color:#a6e22e">+   libtcod.console_print_rect_ex(window, 0, 3, character_screen_width, character_screen_height, libtcod.BKGND_NONE,
</span><span style="color:#a6e22e">+                                 libtcod.LEFT, &#39;Experience: {0}&#39;.format(player.level.current_xp))
</span><span style="color:#a6e22e">+   libtcod.console_print_rect_ex(window, 0, 4, character_screen_width, character_screen_height, libtcod.BKGND_NONE,
</span><span style="color:#a6e22e">+                                 libtcod.LEFT, &#39;Experience to Level: {0}&#39;.format(player.level.experience_to_next_level))
</span><span style="color:#a6e22e">+   libtcod.console_print_rect_ex(window, 0, 6, character_screen_width, character_screen_height, libtcod.BKGND_NONE,
</span><span style="color:#a6e22e">+                                 libtcod.LEFT, &#39;Maximum HP: {0}&#39;.format(player.fighter.max_hp))
</span><span style="color:#a6e22e">+   libtcod.console_print_rect_ex(window, 0, 7, character_screen_width, character_screen_height, libtcod.BKGND_NONE,
</span><span style="color:#a6e22e">+                                 libtcod.LEFT, &#39;Attack: {0}&#39;.format(player.fighter.power))
</span><span style="color:#a6e22e">+   libtcod.console_print_rect_ex(window, 0, 8, character_screen_width, character_screen_height, libtcod.BKGND_NONE,
</span><span style="color:#a6e22e">+                                 libtcod.LEFT, &#39;Defense: {0}&#39;.format(player.fighter.defense))
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   x = screen_width // 2 - character_screen_width // 2
</span><span style="color:#a6e22e">+   y = screen_height // 2 - character_screen_height // 2
</span><span style="color:#a6e22e">+   libtcod.console_blit(window, 0, 0, character_screen_width, character_screen_height, 0, x, y, 1.0, 0.7)
</span><span style="color:#a6e22e"></span>

def message_box(con, header, width, screen_width, screen_height):
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>def level_up_menu(con, header, player, menu_width, screen_width, screen_height):
    ...

<span class="new-text">def character_screen(player, character_screen_width, character_screen_height, screen_width, screen_height):
    window = libtcod.console_new(character_screen_width, character_screen_height)

    libtcod.console_set_default_foreground(window, libtcod.white)

    libtcod.console_print_rect_ex(window, 0, 1, character_screen_width, character_screen_height, libtcod.BKGND_NONE,
                                  libtcod.LEFT, 'Character Information')
    libtcod.console_print_rect_ex(window, 0, 2, character_screen_width, character_screen_height, libtcod.BKGND_NONE,
                                  libtcod.LEFT, 'Level: {0}'.format(player.level.current_level))
    libtcod.console_print_rect_ex(window, 0, 3, character_screen_width, character_screen_height, libtcod.BKGND_NONE,
                                  libtcod.LEFT, 'Experience: {0}'.format(player.level.current_xp))
    libtcod.console_print_rect_ex(window, 0, 4, character_screen_width, character_screen_height, libtcod.BKGND_NONE,
                                  libtcod.LEFT, 'Experience to Level: {0}'.format(player.level.experience_to_next_level))
    libtcod.console_print_rect_ex(window, 0, 6, character_screen_width, character_screen_height, libtcod.BKGND_NONE,
                                  libtcod.LEFT, 'Maximum HP: {0}'.format(player.fighter.max_hp))
    libtcod.console_print_rect_ex(window, 0, 7, character_screen_width, character_screen_height, libtcod.BKGND_NONE,
                                  libtcod.LEFT, 'Attack: {0}'.format(player.fighter.power))
    libtcod.console_print_rect_ex(window, 0, 8, character_screen_width, character_screen_height, libtcod.BKGND_NONE,
                                  libtcod.LEFT, 'Defense: {0}'.format(player.fighter.defense))

    x = screen_width // 2 - character_screen_width // 2
    y = screen_height // 2 - character_screen_height // 2
    libtcod.console_blit(window, 0, 0, character_screen_width, character_screen_height, 0, x, y, 1.0, 0.7)</span>


def message_box(con, header, width, screen_width, screen_height):
    ...
</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>In order to display this new menu, we&rsquo;ll modify <code>render_all</code> once again.
Start by importing the menu.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">import tcod as libtcod

from enum import Enum

from game_states import GameStates

<span style="color:#f92672">-from menus import inventory_menu, level_up_menu
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+from menus import character_screen, inventory_menu, level_up_menu
</span><span style="color:#a6e22e"></span>...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>import tcod as libtcod

from enum import Enum

from game_states import GameStates

from menus import <span class="new-text">character_screen,</span> inventory_menu, level_up_menu
...
</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Now, add the menu to the bottom of <code>render_all</code>.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    elif game_state == GameStates.LEVEL_UP:
        level_up_menu(con, &#39;Level up! Choose a stat to raise:&#39;, player, 40, screen_width, screen_height)

<span style="color:#a6e22e">+   elif game_state == GameStates.CHARACTER_SCREEN:
</span><span style="color:#a6e22e">+       character_screen(player, 30, 10, screen_width, screen_height)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    elif game_state == GameStates.LEVEL_UP:
        level_up_menu(con, 'Level up! Choose a stat to raise:', player, 40, screen_width, screen_height)

    <span class="new-text">elif game_state == GameStates.CHARACTER_SCREEN:
        character_screen(player, 30, 10, screen_width, screen_height)</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Final thing before we wrap up this chapter: Awhile ago, we included
diagonal movement for the player character, but we forgot (okay, <strong>I
forgot</strong>) to include a wait command. It&rsquo;s simple to add, but it&rsquo;s
something we&rsquo;ll definitely want before the next chapter, where the game
will start getting more difficult. Open up <code>input_handlers.py</code> and add
the following to <code>handle_player_turn_keys</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def handle_player_turn_keys(key):
    key_char = chr(key.c)

    if key.vk == libtcod.KEY_UP or key_char == &#39;k&#39;:
        return {&#39;move&#39;: (0, -1)}
    elif key.vk == libtcod.KEY_DOWN or key_char == &#39;j&#39;:
        return {&#39;move&#39;: (0, 1)}
    elif key.vk == libtcod.KEY_LEFT or key_char == &#39;h&#39;:
        return {&#39;move&#39;: (-1, 0)}
    elif key.vk == libtcod.KEY_RIGHT or key_char == &#39;l&#39;:
        return {&#39;move&#39;: (1, 0)}
    elif key_char == &#39;y&#39;:
        return {&#39;move&#39;: (-1, -1)}
    elif key_char == &#39;u&#39;:
        return {&#39;move&#39;: (1, -1)}
    elif key_char == &#39;b&#39;:
        return {&#39;move&#39;: (-1, 1)}
    elif key_char == &#39;n&#39;:
        return {&#39;move&#39;: (1, 1)}
<span style="color:#a6e22e">+   elif key_char == &#39;z&#39;:
</span><span style="color:#a6e22e">+       return {&#39;wait&#39;: True}
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>def handle_player_turn_keys(key):
    key_char = chr(key.c)

    if key.vk == libtcod.KEY_UP or key_char == 'k':
        return {'move': (0, -1)}
    elif key.vk == libtcod.KEY_DOWN or key_char == 'j':
        return {'move': (0, 1)}
    elif key.vk == libtcod.KEY_LEFT or key_char == 'h':
        return {'move': (-1, 0)}
    elif key.vk == libtcod.KEY_RIGHT or key_char == 'l':
        return {'move': (1, 0)}
    elif key_char == 'y':
        return {'move': (-1, -1)}
    elif key_char == 'u':
        return {'move': (1, -1)}
    elif key_char == 'b':
        return {'move': (-1, 1)}
    elif key_char == 'n':
        return {'move': (1, 1)}
    <span class="new-text">elif key_char == 'z':
        return {'wait': True}</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Then, in <code>engine.py</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        move = action.get(&#39;move&#39;)
<span style="color:#a6e22e">+       wait = action.get(&#39;wait&#39;)
</span><span style="color:#a6e22e"></span>        pickup = action.get(&#39;pickup&#39;)
        ...

        if move and game_state == GameStates.PLAYERS_TURN:
            ...

<span style="color:#a6e22e">+       elif wait:
</span><span style="color:#a6e22e">+           game_state = GameStates.ENEMY_TURN
</span><span style="color:#a6e22e"></span>
        elif pickup and game_state == GameStates.PLAYERS_TURN:
            ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        move = action.get('move')
        <span class="new-text">wait = action.get('wait')</span>
        pickup = action.get('pickup')
        ...

        if move and game_state == GameStates.PLAYERS_TURN:
            ...

        <span class="new-text">elif wait:
            game_state = GameStates.ENEMY_TURN</span>

        elif pickup and game_state == GameStates.PLAYERS_TURN:
            ...
</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>So all we&rsquo;re doing is &ldquo;skipping&rdquo; the player&rsquo;s turn. Easy! You could do
a number of things here, like giving the player back 1 HP for waiting,
but I won&rsquo;t do that because I&rsquo;m cruel and unforgiving.</p>
<p>That&rsquo;s all for this chapter. We&rsquo;ve given the player a lot of advantages
(in fact, just one more point in defense makes Orcs a non-threat), but
that&rsquo;s all about to change. Next chapter, we&rsquo;re going to buff up the
monsters, while making the player <em>weaker</em>. This is a roguelike after
all, it&rsquo;s not supposed to be easy!</p>
<p>If you want to see the code so far in its entirety, <a href="https://github.com/TStand90/roguelike_tutorial_revised/tree/part11">click
here</a>.</p>
<p><a href="/tutorials/tcod/2019/part-12">Click here to move on to the next part of this
tutorial.</a></p>
<!-- raw HTML omitted -->


    

    


</article>



        </div>

        <aside class="col-12 col-lg-3 ml-auto blog-sidebar">
    
    
        <section>
    
        
    
        
    
</section>
    
</aside>

      </div>
    </div>
    

    
      







<footer class="blog-footer w-100">
    <nav class="navbar navbar-light bg-light">
        <p class="w-100 text-center">Last updated July 7th, 2020</p>
        <p class="w-100 text-center"><a href="#">Back to top</a></p>
    </nav>
</footer>

    

    
    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  </body>
</html>
