<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Part 12 - Increasing Difficulty" />
<meta property="og:description" content="Despite the fact that we can go down floors now, the dungeon doesn&rsquo;t get progressively more difficult as the player descends. This is because the method in which we place monsters and items is the same on each floor. In this chapter, we&rsquo;ll adjust how we place things in the dungeon, so things get more difficult with each floor.
Currently, we pass maximum_monsters and maximum_items into the place_entities function, and this number does not change." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://rogueliketutorials.com/tutorials/tcod/v2/part-12/" /><meta property="article:section" content="tutorials" />
<meta property="article:published_time" content="2020-07-28T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-07-28T00:00:00&#43;00:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Part 12 - Increasing Difficulty"/>
<meta name="twitter:description" content="Despite the fact that we can go down floors now, the dungeon doesn&rsquo;t get progressively more difficult as the player descends. This is because the method in which we place monsters and items is the same on each floor. In this chapter, we&rsquo;ll adjust how we place things in the dungeon, so things get more difficult with each floor.
Currently, we pass maximum_monsters and maximum_items into the place_entities function, and this number does not change."/>



    <link rel="canonical" href="https://rogueliketutorials.com/tutorials/tcod/v2/part-12/">

    <title>
      
        Part 12 - Increasing Difficulty | Roguelike Tutorials
      
    </title>

    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="https://rogueliketutorials.com/css/style.css" rel="stylesheet">

    

    

    
  </head>
  <body>
    
      

<header class="blog-header">
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <a class="navbar-brand" href="/">
            Roguelike Tutorials
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
            <ul class="navbar-nav">
                
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/">Home</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/tutorials/tcod/2019/">TCOD Tutorial (2019)</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/tutorials/tcod/v2/">TCOD Tutorial (2020)</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/about/">About</a>
                    
                </li>
                
            </ul>
            
        </div>
    </nav>
</header>

    

    
    <div class="container">
      <div class="row">
        <div class="col-12 col-lg-8 blog-main">

          

<header>
    <h2 class="blog-post-title">
    <a class="text-dark" href="/tutorials/tcod/v2/part-12/">Part 12 - Increasing Difficulty</a>
</h2>

    


<div class="blog-post-date text-secondary">
    
        <time datetime="2020-07-28">Jul 28, 2020</time>
    
    
</div>

    
    
    <hr>
</header>
<article class="blog-post">
    <p>Despite the fact that we can go down floors now, the dungeon doesn&rsquo;t get progressively more difficult as the player descends. This is because the method in which we place monsters and items is the same on each floor. In this chapter, we&rsquo;ll adjust how we place things in the dungeon, so things get more difficult with each floor.</p>
<p>Currently, we pass <code>maximum_monsters</code> and <code>maximum_items</code> into the <code>place_entities</code> function, and this number does not change. To adjust the difficulty of our game, we can change these numbers based on the floor number. The way we&rsquo;ll accomplish this is by setting up a list of tuples, which will contain two integers: the floor number, and the number of items/monsters.</p>
<p>Add the following to <code>procgen.py</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">...
if TYPE_CHECKING:
    from engine import Engine


<span style="color:#a6e22e">+max_items_by_floor = [
</span><span style="color:#a6e22e">+   (1, 1),
</span><span style="color:#a6e22e">+   (4, 2),
</span><span style="color:#a6e22e">+]
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+max_monsters_by_floor = [
</span><span style="color:#a6e22e">+   (1, 2),
</span><span style="color:#a6e22e">+   (4, 3),
</span><span style="color:#a6e22e">+   (6, 5),
</span><span style="color:#a6e22e">+]
</span><span style="color:#a6e22e"></span>

class RectangularRoom:
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>...
if TYPE_CHECKING:
    from engine import Engine


<span class="new-text">max_items_by_floor = [
    (1, 1),
    (4, 2),
]

max_monsters_by_floor = [
    (1, 2),
    (4, 3),
    (6, 5),
]</span>


class RectangularRoom:
    ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>As mentioned, the first number in these tuples represents the floor number, and the second represents the maximum of either the items or the monsters.</p>
<p>You might be wondering why we&rsquo;ve only supplied values for only certain floors. Rather than having to type out each floor number, we&rsquo;ll provide the floor numbers that have a different value, so that we can loop through the list and stop when we hit a floor number higher than the one we&rsquo;re on. For example, if we&rsquo;re on floor 3, we&rsquo;ll take the floor 1 entry for both items and monsters, and stop iteration when we reach the second item in the list, since floor 4 is higher than floor 3.</p>
<p>Let&rsquo;s write the function to take care of this. We&rsquo;ll call it <code>get_max_value_for_floor</code>, as we&rsquo;re getting the maximum value for either the items or monsters. It looks like this:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">...
max_items_by_floor = [
    (1, 1),
    (4, 2),
]

max_monsters_by_floor = [
    (1, 2),
    (4, 3),
    (6, 5),
]


<span style="color:#a6e22e">+def get_max_value_for_floor(
</span><span style="color:#a6e22e">+   weighted_chances_by_floor: List[Tuple[int, int]], floor: int
</span><span style="color:#a6e22e">+) -&gt; int:
</span><span style="color:#a6e22e">+   current_value = 0
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+   for floor_minimum, value in weighted_chances_by_floor:
</span><span style="color:#a6e22e">+       if floor_minimum &gt; floor:
</span><span style="color:#a6e22e">+           break
</span><span style="color:#a6e22e">+       else:
</span><span style="color:#a6e22e">+           current_value = value
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+   return current_value
</span><span style="color:#a6e22e"></span>

class RectangularRoom:
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>...
max_items_by_floor = [
    (1, 1),
    (4, 2),
]

max_monsters_by_floor = [
    (1, 2),
    (4, 3),
    (6, 5),
]


<span class="new-text">def get_max_value_for_floor(
    max_value_by_floor: List[Tuple[int, int]], floor: int
) -> int:
    current_value = 0

    for floor_minimum, value in max_value_by_floor:
        if floor_minimum > floor:
            break
        else:
            current_value = value

    return current_value</span>


class RectangularRoom:
    ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Using this function is quite simple: we simply remove the <code>maximum_monsters</code> and <code>maximum_items</code> parameters from the <code>place_entities</code> function, pass the <code>floor_number</code> instead, and use that to get our maximum values from the <code>get_max_value_for_floor</code> function.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">-def place_entities(
</span><span style="color:#f92672">-   room: RectangularRoom, dungeon: GameMap, maximum_monsters: int, maximum_items: int
</span><span style="color:#f92672">-) -&gt; None:
</span><span style="color:#f92672">-   number_of_monsters = random.randint(0, maximum_monsters)
</span><span style="color:#f92672">-   number_of_items = random.randint(0, maximum_items)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+def place_entities(room: RectangularRoom, dungeon: GameMap, floor_number: int,) -&gt; None:
</span><span style="color:#a6e22e">+   number_of_monsters = random.randint(
</span><span style="color:#a6e22e">+       0, get_max_value_for_floor(max_monsters_by_floor, floor_number)
</span><span style="color:#a6e22e">+   )
</span><span style="color:#a6e22e">+   number_of_items = random.randint(
</span><span style="color:#a6e22e">+       0, get_max_value_for_floor(max_items_by_floor, floor_number)
</span><span style="color:#a6e22e">+   )
</span><span style="color:#a6e22e"></span>
    for i in range(number_of_monsters):
        ...

...

def generate_dungeon(
    max_rooms: int,
    room_min_size: int,
    room_max_size: int,
    map_width: int,
    map_height: int,
<span style="color:#f92672">-   max_monsters_per_room: int,
</span><span style="color:#f92672">-   max_items_per_room: int,
</span><span style="color:#f92672"></span>    engine: Engine,
) -&gt; GameMap:
    ...

            ...
            center_of_last_room = new_room.center

<span style="color:#f92672">-       place_entities(new_room, dungeon, max_monsters_per_room, max_items_per_room)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       place_entities(new_room, dungeon, engine.game_world.current_floor)
</span><span style="color:#a6e22e"></span>
        dungeon.tiles[center_of_last_room] = tile_types.down_stairs
        dungeon.downstairs_location = center_of_last_room
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre><span class="crossed-out-text">def place_entities(</span>
    <span class="crossed-out-text">room: RectangularRoom, dungeon: GameMap, maximum_monsters: int, maximum_items: int</span>
<span class="crossed-out-text">) -> None:</span>
    <span class="crossed-out-text">number_of_monsters = random.randint(0, maximum_monsters)</span>
    <span class="crossed-out-text">number_of_items = random.randint(0, maximum_items)</span>
<span class="new-text">def place_entities(room: RectangularRoom, dungeon: GameMap, floor_number: int,) -> None:
    number_of_monsters = random.randint(
        0, get_max_value_for_floor(max_monsters_by_floor, floor_number)
    )
    number_of_items = random.randint(
        0, get_max_value_for_floor(max_items_by_floor, floor_number)
    )</span>

    for i in range(number_of_monsters):
        ...

...

def generate_dungeon(
    max_rooms: int,
    room_min_size: int,
    room_max_size: int,
    map_width: int,
    map_height: int,
    <span class="crossed-out-text">max_monsters_per_room: int,</span>
    <span class="crossed-out-text">max_items_per_room: int,</span>
    engine: Engine,
) -> GameMap:
    ...

            ...
            center_of_last_room = new_room.center

        <span class="crossed-out-text">place_entities(new_room, dungeon, max_monsters_per_room, max_items_per_room)</span>
        <span class="new-text">place_entities(new_room, dungeon, engine.game_world.current_floor)</span>

        dungeon.tiles[center_of_last_room] = tile_types.down_stairs
        dungeon.downstairs_location = center_of_last_room</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>We can also remove <code>max_monsters_per_room</code> and <code>max_items_per_room</code> from <code>GameWorld</code>. Remove these lines from <code>game_map.py</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class GameWorld:
    &#34;&#34;&#34;
    Holds the settings for the GameMap, and generates new maps when moving down the stairs.
    &#34;&#34;&#34;

    def __init__(
        self,
        *,
        engine: Engine,
        map_width: int,
        map_height: int,
        max_rooms: int,
        room_min_size: int,
        room_max_size: int,
<span style="color:#f92672">-       max_monsters_per_room: int,
</span><span style="color:#f92672">-       max_items_per_room: int,
</span><span style="color:#f92672"></span>        current_floor: int = 0
    ):
        self.engine = engine

        self.map_width = map_width
        self.map_height = map_height

        self.max_rooms = max_rooms

        self.room_min_size = room_min_size
        self.room_max_size = room_max_size

<span style="color:#f92672">-       self.max_monsters_per_room = max_monsters_per_room
</span><span style="color:#f92672">-       self.max_items_per_room = max_items_per_room
</span><span style="color:#f92672"></span>
        self.current_floor = current_floor

    def generate_floor(self) -&gt; None:
        from procgen import generate_dungeon

        self.current_floor += 1

        self.engine.game_map = generate_dungeon(
            max_rooms=self.max_rooms,
            room_min_size=self.room_min_size,
            room_max_size=self.room_max_size,
            map_width=self.map_width,
            map_height=self.map_height,
<span style="color:#f92672">-           max_monsters_per_room=self.max_monsters_per_room,
</span><span style="color:#f92672">-           max_items_per_room=self.max_items_per_room,
</span><span style="color:#f92672"></span>            engine=self.engine,
        )
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class GameWorld:
    """
    Holds the settings for the GameMap, and generates new maps when moving down the stairs.
    """

    def __init__(
        self,
        *,
        engine: Engine,
        map_width: int,
        map_height: int,
        max_rooms: int,
        room_min_size: int,
        room_max_size: int,
        <span class="crossed-out-text">max_monsters_per_room: int,</span>
        <span class="crossed-out-text">max_items_per_room: int,</span>
        current_floor: int = 0
    ):
        self.engine = engine

        self.map_width = map_width
        self.map_height = map_height

        self.max_rooms = max_rooms

        self.room_min_size = room_min_size
        self.room_max_size = room_max_size

        <span class="crossed-out-text">self.max_monsters_per_room = max_monsters_per_room</span>
        <span class="crossed-out-text">self.max_items_per_room = max_items_per_room</span>

        self.current_floor = current_floor

    def generate_floor(self) -> None:
        from procgen import generate_dungeon

        self.current_floor += 1

        self.engine.game_map = generate_dungeon(
            max_rooms=self.max_rooms,
            room_min_size=self.room_min_size,
            room_max_size=self.room_max_size,
            map_width=self.map_width,
            map_height=self.map_height,
            <span class="crossed-out-text">max_monsters_per_room=self.max_monsters_per_room,</span>
            <span class="crossed-out-text">max_items_per_room=self.max_items_per_room,</span>
            engine=self.engine,
        )</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Also remove the same variables from <code>setup_game.py</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def new_game() -&gt; Engine:
    &#34;&#34;&#34;Return a brand new game session as an Engine instance.&#34;&#34;&#34;
    map_width = 80
    map_height = 43

    room_max_size = 10
    room_min_size = 6
    max_rooms = 30

<span style="color:#f92672">-   max_monsters_per_room = 2
</span><span style="color:#f92672">-   max_items_per_room = 2
</span><span style="color:#f92672"></span>
    player = copy.deepcopy(entity_factories.player)

    engine = Engine(player=player)

    engine.game_world = GameWorld(
        engine=engine,
        max_rooms=max_rooms,
        room_min_size=room_min_size,
        room_max_size=room_max_size,
        map_width=map_width,
        map_height=map_height,
<span style="color:#f92672">-       max_monsters_per_room=max_monsters_per_room,
</span><span style="color:#f92672">-       max_items_per_room=max_items_per_room,
</span><span style="color:#f92672"></span>    )

    engine.game_world.generate_floor()
    engine.update_fov()

    engine.message_log.add_message(
        &#34;Hello and welcome, adventurer, to yet another dungeon!&#34;, color.welcome_text
    )
    return engine
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>def new_game() -> Engine:
    """Return a brand new game session as an Engine instance."""
    map_width = 80
    map_height = 43

    room_max_size = 10
    room_min_size = 6
    max_rooms = 30

    <span class="crossed-out-text">max_monsters_per_room = 2</span>
    <span class="crossed-out-text">max_items_per_room = 2</span>

    player = copy.deepcopy(entity_factories.player)

    engine = Engine(player=player)

    engine.game_world = GameWorld(
        engine=engine,
        max_rooms=max_rooms,
        room_min_size=room_min_size,
        room_max_size=room_max_size,
        map_width=map_width,
        map_height=map_height,
        <span class="crossed-out-text">max_monsters_per_room=max_monsters_per_room,</span>
        <span class="crossed-out-text">max_items_per_room=max_items_per_room,</span>
    )

    engine.game_world.generate_floor()
    engine.update_fov()

    engine.message_log.add_message(
        "Hello and welcome, adventurer, to yet another dungeon!", color.welcome_text
    )
    return engine</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Now we&rsquo;re adjusting the number of items and monsters based on the floor. The next step is to control which entities appear on which floor, instead of allowing any entity to appear on any floor. The first floor will only have health potions and orcs, and we&rsquo;ll gradually add different items and enemies as the player goes deeper into the dungeon.</p>
<p>We need a function that allows us to get these entities at random, based on a set of weights. We also need to define the weights themselves.</p>
<p>What are &ldquo;weights&rdquo; in this context? Basically, we could define all of the odds of generating a type of entity the way we have already, by getting a random number and comparing against a set of values, but that will quickly become cumbersome as we add more entities. Imagine wanting to add a new enemy type, but needing to adjust the values for dozens, or perhaps <strong>hundreds</strong>, of other entities.</p>
<p>Instead, we&rsquo;ll just give each entity a value, or a &ldquo;weight&rdquo;, which we&rsquo;ll use to determine how common that entity should be. We&rsquo;ll use Python&rsquo;s <code>random.choices</code> function, which allows the user to pass a list of items and a set of weights. It returns a number of items that you specify, based on the weights you give it.</p>
<p>First, we need to define our weights for the entity types, along with the minimum floor that the item or monster will appear on. Add the following to <code>procgen.py</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">from __future__ import annotations

import random
<span style="color:#f92672">-from typing import Iterator, List, Tuple, TYPE_CHECKING
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+from typing import Dict, Iterator, List, Tuple, TYPE_CHECKING
</span><span style="color:#a6e22e"></span>
import tcod

import entity_factories
from game_map import GameMap
import tile_types

if TYPE_CHECKING:
    from engine import Engine
<span style="color:#a6e22e">+   from entity import Entity
</span><span style="color:#a6e22e"></span>

max_items_by_floor = [
    (1, 1),
    (4, 2),
]

max_monsters_by_floor = [
    (1, 2),
    (4, 3),
    (6, 5),
]

<span style="color:#a6e22e">+item_chances: Dict[int, List[Tuple[Entity, int]]] = {
</span><span style="color:#a6e22e">+   0: [(entity_factories.health_potion, 35)],
</span><span style="color:#a6e22e">+   2: [(entity_factories.confusion_scroll, 10)],
</span><span style="color:#a6e22e">+   4: [(entity_factories.lightning_scroll, 25)],
</span><span style="color:#a6e22e">+   6: [(entity_factories.fireball_scroll, 25)],
</span><span style="color:#a6e22e">+}
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+enemy_chances: Dict[int, List[Tuple[Entity, int]]] = {
</span><span style="color:#a6e22e">+   0: [(entity_factories.orc, 80)],
</span><span style="color:#a6e22e">+   3: [(entity_factories.troll, 15)],
</span><span style="color:#a6e22e">+   5: [(entity_factories.troll, 30)],
</span><span style="color:#a6e22e">+   7: [(entity_factories.troll, 60)],
</span><span style="color:#a6e22e">+}
</span><span style="color:#a6e22e"></span>

def get_max_value_for_floor(
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>from __future__ import annotations

import random
<span class="crossed-out-text">from typing import Iterator, List, Tuple, TYPE_CHECKING</span>
<span class="new-text">from typing import Dict, Iterator, List, Tuple, TYPE_CHECKING</span>

import tcod

import entity_factories
from game_map import GameMap
import tile_types

if TYPE_CHECKING:
    from engine import Engine
    <span class="new-text">from entity import Entity</span>


max_items_by_floor = [
    (1, 1),
    (4, 2),
]

max_monsters_by_floor = [
    (1, 2),
    (4, 3),
    (6, 5),
]

<span class="new-text">item_chances: Dict[int, List[Tuple[Entity, int]]] = {
    0: [(entity_factories.health_potion, 35)],
    2: [(entity_factories.confusion_scroll, 10)],
    4: [(entity_factories.lightning_scroll, 25)],
    6: [(entity_factories.fireball_scroll, 25)],
}

enemy_chances: Dict[int, List[Tuple[Entity, int]]] = {
    0: [(entity_factories.orc, 80)],
    3: [(entity_factories.troll, 15)],
    5: [(entity_factories.troll, 30)],
    7: [(entity_factories.troll, 60)],
}</span>


def get_max_value_for_floor(
    ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>They keys in the dictionary represent the floor number, and the value is a list of tuples. The tuples contain an entity and the weights at which they&rsquo;ll be generated. Notice that Trolls get defined multiple times in <code>enemy_chances</code>, and their weights grow higher when the floor number increases. This will allow Trolls to be generated more frequently as the player dives into the dungeon, thus making the dungeon more dangerous with each passing floor.</p>
<p>Why a <em>list</em> of tuples, though? While there isn&rsquo;t any examples here, we want it to be possible to define many entity types and weights for each floor. For example, imagine we added a new enemy type that appears on floor 5. We could put that as a tuple inside the list, alongside the Troll&rsquo;s tuple. We&rsquo;ll see an example of this in the next chapter, when we start adding equipment.</p>
<p>With our weights defined, we need a function to actually pick which entities we want to create. As mentioned, it will utilize <code>random.choices</code> from the Python standard library to choose the entities. Add this function to <code>procgen.py</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def get_max_value_for_floor(
    weighted_chances_by_floor: List[Tuple[int, int]], floor: int
) -&gt; int:
    ...


<span style="color:#a6e22e">+def get_entities_at_random(
</span><span style="color:#a6e22e">+   weighted_chances_by_floor: Dict[int, List[Tuple[Entity, int]]],
</span><span style="color:#a6e22e">+   number_of_entities: int,
</span><span style="color:#a6e22e">+   floor: int,
</span><span style="color:#a6e22e">+) -&gt; List[Entity]:
</span><span style="color:#a6e22e">+   entity_weighted_chances = {}
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+   for key, values in weighted_chances_by_floor.items():
</span><span style="color:#a6e22e">+       if key &gt; floor:
</span><span style="color:#a6e22e">+           break
</span><span style="color:#a6e22e">+       else:
</span><span style="color:#a6e22e">+           for value in values:
</span><span style="color:#a6e22e">+               entity = value[0]
</span><span style="color:#a6e22e">+               weighted_chance = value[1]
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+               entity_weighted_chances[entity] = weighted_chance
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+   entities = list(entity_weighted_chances.keys())
</span><span style="color:#a6e22e">+   entity_weighted_chance_values = list(entity_weighted_chances.values())
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+   chosen_entities = random.choices(
</span><span style="color:#a6e22e">+       entities, weights=entity_weighted_chance_values, k=number_of_entities
</span><span style="color:#a6e22e">+   )
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+   return chosen_entities
</span><span style="color:#a6e22e"></span>

class RectangularRoom:
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>def get_max_value_for_floor(
    weighted_chances_by_floor: List[Tuple[int, int]], floor: int
) -> int:
    ...


<span class="new-text">def get_entities_at_random(
    weighted_chances_by_floor: Dict[int, List[Tuple[Entity, int]]],
    number_of_entities: int,
    floor: int,
) -> List[Entity]:
    entity_weighted_chances = {}

    for key, values in weighted_chances_by_floor.items():
        if key > floor:
            break
        else:
            for value in values:
                entity = value[0]
                weighted_chance = value[1]

                entity_weighted_chances[entity] = weighted_chance

    entities = list(entity_weighted_chances.keys())
    entity_weighted_chance_values = list(entity_weighted_chances.values())

    chosen_entities = random.choices(
        entities, weights=entity_weighted_chance_values, k=number_of_entities
    )

    return chosen_entities</span>


class RectangularRoom:
    ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>This function goes through they keys (floor numbers) and values (list of weighted entities), stopping when the key is higher than the given floor number. It sets up a dictionary of the weights for each entity, based on which floor the player is currently on. So if we were trying to get the weights for floor 6, <code>entity_weighted_chances</code> would look like this: <code>{ orc: 80, troll: 30 }</code>.</p>
<p>Then, we get both the keys and values in list format, so that they can be passed to <code>random.choices</code> (it accepts choices and weights as lists). <code>k</code> represents the number of items that <code>random.choices</code> should pick, so we can simply pass the number of entities we&rsquo;ve decided to generate. Finally, we return the list of chosen entities.</p>
<p>Putting this function to use is quite simple. In fact, it will reduce the amount of code in our <code>place_entities</code> function quite nicely:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def place_entities(room: RectangularRoom, dungeon: GameMap, floor_number: int,) -&gt; None:
    number_of_monsters = random.randint(
        0, get_weight_for_floor(max_monsters_by_floor, floor_number)
    )
    number_of_items = random.randint(
        0, get_weight_for_floor(max_items_by_floor, floor_number)
    )

<span style="color:#a6e22e">+   monsters: List[Entity] = get_entities_at_random(
</span><span style="color:#a6e22e">+       enemy_chances, number_of_monsters, floor_number
</span><span style="color:#a6e22e">+   )
</span><span style="color:#a6e22e">+   items: List[Entity] = get_entities_at_random(
</span><span style="color:#a6e22e">+       item_chances, number_of_items, floor_number
</span><span style="color:#a6e22e">+   )
</span><span style="color:#a6e22e"></span>
<span style="color:#f92672">-   for i in range(number_of_monsters):
</span><span style="color:#f92672">-       x = random.randint(room.x1 + 1, room.x2 - 1)
</span><span style="color:#f92672">-       y = random.randint(room.y1 + 1, room.y2 - 1)
</span><span style="color:#f92672"></span>
<span style="color:#f92672">-       if not any(entity.x == x and entity.y == y for entity in dungeon.entities):
</span><span style="color:#f92672">-           if random.random() &lt; 0.8:
</span><span style="color:#f92672">-               entity_factories.orc.spawn(dungeon, x, y)
</span><span style="color:#f92672">-           else:
</span><span style="color:#f92672">-               entity_factories.troll.spawn(dungeon, x, y)
</span><span style="color:#f92672"></span>
<span style="color:#f92672">-   for i in range(number_of_items):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   for entity in monsters + items:
</span><span style="color:#a6e22e"></span>        x = random.randint(room.x1 + 1, room.x2 - 1)
        y = random.randint(room.y1 + 1, room.y2 - 1)

        if not any(entity.x == x and entity.y == y for entity in dungeon.entities):
<span style="color:#f92672">-           item_chance = random.random()
</span><span style="color:#f92672"></span>
<span style="color:#f92672">-           if item_chance &lt; 0.7:
</span><span style="color:#f92672">-               entity_factories.health_potion.spawn(dungeon, x, y)
</span><span style="color:#f92672">-           elif item_chance &lt; 0.80:
</span><span style="color:#f92672">-               entity_factories.fireball_scroll.spawn(dungeon, x, y)
</span><span style="color:#f92672">-           elif item_chance &lt; 0.90:
</span><span style="color:#f92672">-               entity_factories.confusion_scroll.spawn(dungeon, x, y)
</span><span style="color:#f92672">-           else:
</span><span style="color:#f92672">-               entity_factories.lightning_scroll.spawn(dungeon, x, y)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+           entity.spawn(dungeon, x, y)
</span><span style="color:#a6e22e"></span>
...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>def place_entities(room: RectangularRoom, dungeon: GameMap, floor_number: int,) -> None:
    number_of_monsters = random.randint(
        0, get_weight_for_floor(max_monsters_by_floor, floor_number)
    )
    number_of_items = random.randint(
        0, get_weight_for_floor(max_items_by_floor, floor_number)
    )

    <span class="new-text">monsters: List[Entity] = get_entities_at_random(
        enemy_chances, number_of_monsters, floor_number
    )
    items: List[Entity] = get_entities_at_random(
        item_chances, number_of_items, floor_number
    )</span>

    <span class="crossed-out-text">for i in range(number_of_monsters):</span>
        <span class="crossed-out-text">x = random.randint(room.x1 + 1, room.x2 - 1)</span>
        <span class="crossed-out-text">y = random.randint(room.y1 + 1, room.y2 - 1)</span>

        <span class="crossed-out-text">if not any(entity.x == x and entity.y == y for entity in dungeon.entities):</span>
            <span class="crossed-out-text">if random.random() < 0.8:</span>
                <span class="crossed-out-text">entity_factories.orc.spawn(dungeon, x, y)</span>
            <span class="crossed-out-text">else:</span>
                <span class="crossed-out-text">entity_factories.troll.spawn(dungeon, x, y)</span>

    <span class="crossed-out-text">for i in range(number_of_items):</span>
    <span class="new-text">for entity in monsters + items:</span>
        x = random.randint(room.x1 + 1, room.x2 - 1)
        y = random.randint(room.y1 + 1, room.y2 - 1)

        if not any(entity.x == x and entity.y == y for entity in dungeon.entities):
            <span class="crossed-out-text">item_chance = random.random()</span>

            <span class="crossed-out-text">if item_chance < 0.7:</span>
                <span class="crossed-out-text">entity_factories.health_potion.spawn(dungeon, x, y)</span>
            <span class="crossed-out-text">elif item_chance < 0.80:</span>
                <span class="crossed-out-text">entity_factories.fireball_scroll.spawn(dungeon, x, y)</span>
            <span class="crossed-out-text">elif item_chance < 0.90:</span>
                <span class="crossed-out-text">entity_factories.confusion_scroll.spawn(dungeon, x, y)</span>
            <span class="crossed-out-text">else:</span>
                <span class="crossed-out-text">entity_factories.lightning_scroll.spawn(dungeon, x, y)</span>
            <span class="new-text">entity.spawn(dungeon, x, y)</span>

...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Now <code>place_entities</code> is just getting the amount of monsters and items to generate, and leaving it up to <code>get_entities_at_random</code> to determine which ones to create.</p>
<p>With those changes, the dungeon will get progressively more difficult! You may want to tweak certain numbers, like the strength of the enemies or how much health you recover with potions, to get a more challenging experience (our game is still not <em>that</em> difficult, if you increase your defense by just 1, Orcs are no longer a threat).</p>
<p>If you want to see the code so far in its entirety, <a href="https://github.com/TStand90/tcod_tutorial_v2/tree/2020/part-12">click here</a>.</p>
<p><a href="/tutorials/tcod/v2/part-13">Click here to move on to the next part of this tutorial.</a></p>


    

    


</article>



        </div>

        <aside class="col-12 col-lg-3 ml-auto blog-sidebar">
    
    
        <section>
    
        
    
        
    
</section>
    
</aside>

      </div>
    </div>
    

    
      







<footer class="blog-footer w-100">
    <nav class="navbar navbar-light bg-light">
        <p class="w-100 text-center">Last updated July 7th, 2020</p>
        <p class="w-100 text-center"><a href="#">Back to top</a></p>
    </nav>
</footer>

    

    
    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  </body>
</html>
