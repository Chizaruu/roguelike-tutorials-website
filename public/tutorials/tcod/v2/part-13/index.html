<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Part 13 - Gearing up" />
<meta property="og:description" content="For the final part of this tutorial, we&rsquo;ll implement something that most roguelikes have: equipment. Our implementation will be extremely simple: equipping a weapon increases attack power, and equipping armor increases defense. Many roguelikes have more equipment types than just these two, and the effects of equipment can go much further than this, but this should be enough to get you started.
First, we&rsquo;ll want to define the types of equipment that can be found in the dungeon." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://rogueliketutorials.com/tutorials/tcod/v2/part-13/" /><meta property="article:section" content="tutorials" />
<meta property="article:published_time" content="2020-07-28T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2020-07-28T00:00:00&#43;00:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Part 13 - Gearing up"/>
<meta name="twitter:description" content="For the final part of this tutorial, we&rsquo;ll implement something that most roguelikes have: equipment. Our implementation will be extremely simple: equipping a weapon increases attack power, and equipping armor increases defense. Many roguelikes have more equipment types than just these two, and the effects of equipment can go much further than this, but this should be enough to get you started.
First, we&rsquo;ll want to define the types of equipment that can be found in the dungeon."/>



    <link rel="canonical" href="https://rogueliketutorials.com/tutorials/tcod/v2/part-13/">

    <title>
      
        Part 13 - Gearing up | Roguelike Tutorials
      
    </title>

    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="https://rogueliketutorials.com/css/style.css" rel="stylesheet">

    

    

    
  </head>
  <body>
    
      

<header class="blog-header">
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <a class="navbar-brand" href="/">
            Roguelike Tutorials
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
            <ul class="navbar-nav">
                
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/">Home</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/tutorials/tcod/2019/">TCOD Tutorial (2019)</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/tutorials/tcod/v2/">TCOD Tutorial (2020)</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/about/">About</a>
                    
                </li>
                
            </ul>
            
        </div>
    </nav>
</header>

    

    
    <div class="container">
      <div class="row">
        <div class="col-12 col-lg-8 blog-main">

          

<header>
    <h2 class="blog-post-title">
    <a class="text-dark" href="/tutorials/tcod/v2/part-13/">Part 13 - Gearing up</a>
</h2>

    


<div class="blog-post-date text-secondary">
    
        <time datetime="2020-07-28">Jul 28, 2020</time>
    
    
</div>

    
    
    <hr>
</header>
<article class="blog-post">
    <p>For the final part of this tutorial, we&rsquo;ll implement something that <em>most</em> roguelikes have: equipment. Our implementation will be extremely simple: equipping a weapon increases attack power, and equipping armor increases defense. Many roguelikes have more equipment types than just these two, and the effects of equipment can go much further than this, but this should be enough to get you started.</p>
<p>First, we&rsquo;ll want to define the types of equipment that can be found in the dungeon. As with the <code>RenderOrder</code> class, we can use <code>Enum</code> to define the types. For now, we&rsquo;ll leave it at weapons and armor, but feel free to add more types as you see fit.</p>
<p>Create a new file, <code>equipment_types.py</code>, and put the following contents in it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#f92672">from</span> enum <span style="color:#f92672">import</span> auto, Enum


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EquipmentType</span>(Enum):
    WEAPON <span style="color:#f92672">=</span> auto()
    ARMOR <span style="color:#f92672">=</span> auto()
</code></pre></div><p>Now it&rsquo;s time to create the component that we&rsquo;ll attach to the equipment. We&rsquo;ll call the component <code>Equippable</code>, which will have a few different attributes:</p>
<ul>
<li><code>equipment_type</code>: The type of equipment, using the <code>EquipmentType</code> enum.</li>
<li><code>power_bonus</code>: How much the wielder&rsquo;s attack power will be increased. Currently used for just weapons.</li>
<li><code>defense_bonus</code>: How much the wearer&rsquo;s defense will be increased. Currently just for armor.</li>
</ul>
<p>Create the file <code>equippable.py</code> in the <code>components</code> directory, and fill it with the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> annotations

<span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> TYPE_CHECKING

<span style="color:#f92672">from</span> components.base_component <span style="color:#f92672">import</span> BaseComponent
<span style="color:#f92672">from</span> equipment_types <span style="color:#f92672">import</span> EquipmentType

<span style="color:#66d9ef">if</span> TYPE_CHECKING:
    <span style="color:#f92672">from</span> entity <span style="color:#f92672">import</span> Item


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Equippable</span>(BaseComponent):
    parent: Item

    <span style="color:#66d9ef">def</span> __init__(
        self,
        equipment_type: EquipmentType,
        power_bonus: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
        defense_bonus: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
    ):
        self<span style="color:#f92672">.</span>equipment_type <span style="color:#f92672">=</span> equipment_type

        self<span style="color:#f92672">.</span>power_bonus <span style="color:#f92672">=</span> power_bonus
        self<span style="color:#f92672">.</span>defense_bonus <span style="color:#f92672">=</span> defense_bonus


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Dagger</span>(Equippable):
    <span style="color:#66d9ef">def</span> __init__(self) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
        super()<span style="color:#f92672">.</span>__init__(equipment_type<span style="color:#f92672">=</span>EquipmentType<span style="color:#f92672">.</span>WEAPON, power_bonus<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Sword</span>(Equippable):
    <span style="color:#66d9ef">def</span> __init__(self) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
        super()<span style="color:#f92672">.</span>__init__(equipment_type<span style="color:#f92672">=</span>EquipmentType<span style="color:#f92672">.</span>WEAPON, power_bonus<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LeatherArmor</span>(Equippable):
    <span style="color:#66d9ef">def</span> __init__(self) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
        super()<span style="color:#f92672">.</span>__init__(equipment_type<span style="color:#f92672">=</span>EquipmentType<span style="color:#f92672">.</span>ARMOR, defense_bonus<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ChainMail</span>(Equippable):
    <span style="color:#66d9ef">def</span> __init__(self) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
        super()<span style="color:#f92672">.</span>__init__(equipment_type<span style="color:#f92672">=</span>EquipmentType<span style="color:#f92672">.</span>ARMOR, defense_bonus<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)
</code></pre></div><p>Aside from creating the <code>Equippable</code> class, as described earlier, we&rsquo;ve also created a few types of equippable components, for each equippable entity that we&rsquo;ll end up creating, similar to what we did with the <code>Consumable</code> classes. You don&rsquo;t have to do it this way, you could just define these when creating the entities, but you might want to add additional functionality to weapons and armor at some point, and defining the <code>Equippable</code> classes this way might make that easier. You might also want to move these classes to their own file, but that&rsquo;s outside the scope of this tutorial.</p>
<p>To create the actual equippable entities, we&rsquo;ll want to adjust our <code>Item</code> class. We can use the same class that we used for our consumables, and just handle them slightly differently. Another approach would be to create another subclass of <code>Entity</code>, but for the sake of keeping the number of <code>Entity</code> subclasses in this tutorial short, we&rsquo;ll adjust <code>Item</code>. Make the following adjustments to <code>entity.py</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">...
if TYPE_CHECKING:
    from components.ai import BaseAI
    from components.consumable import Consumable
<span style="color:#a6e22e">+   from components.equippable import Equippable
</span><span style="color:#a6e22e"></span>    from components.fighter import Fighter
    from components.inventory import Inventory
    from components.level import Level
    from game_map import GameMap
...

class Item(Entity):
    def __init__(
        self,
        *,
        x: int = 0,
        y: int = 0,
        char: str = &#34;?&#34;,
        color: Tuple[int, int, int] = (255, 255, 255),
        name: str = &#34;&lt;Unnamed&gt;&#34;,
<span style="color:#f92672">-       consumable: Consumable,
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       consumable: Optional[Consumable] = None,
</span><span style="color:#a6e22e">+       equippable: Optional[Equippable] = None,
</span><span style="color:#a6e22e"></span>    ):
        super().__init__(
            x=x,
            y=y,
            char=char,
            color=color,
            name=name,
            blocks_movement=False,
            render_order=RenderOrder.ITEM,
        )

        self.consumable = consumable
<span style="color:#f92672">-       self.consumable.parent = self
</span><span style="color:#f92672"></span>
<span style="color:#a6e22e">+       if self.consumable:
</span><span style="color:#a6e22e">+           self.consumable.parent = self
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+       self.equippable = equippable
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+       if self.equippable:
</span><span style="color:#a6e22e">+           self.equippable.parent = self
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>...
if TYPE_CHECKING:
    from components.ai import BaseAI
    from components.consumable import Consumable
    <span class="new-text">from components.equippable import Equippable</span>
    from components.fighter import Fighter
    from components.inventory import Inventory
    from components.level import Level
    from game_map import GameMap
...

class Item(Entity):
    def __init__(
        self,
        *,
        x: int = 0,
        y: int = 0,
        char: str = "?",
        color: Tuple[int, int, int] = (255, 255, 255),
        name: str = "&lt;Unnamed&gt;",
        <span class="crossed-out-text">consumable: Consumable,</span>
        <span class="new-text">consumable: Optional[Consumable] = None,
        equippable: Optional[Equippable] = None,</span>
    ):
        super().__init__(
            x=x,
            y=y,
            char=char,
            color=color,
            name=name,
            blocks_movement=False,
            render_order=RenderOrder.ITEM,
        )

        self.consumable = consumable
        <span class="crossed-out-text">self.consumable.parent = self</span>

        <span class="new-text">if self.consumable:
            self.consumable.parent = self

        self.equippable = equippable

        if self.equippable:
            self.equippable.parent = self</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>We&rsquo;ve added <code>Equippable</code> as an optional component for the <code>Item</code> class, and also made <code>Consumable</code> optional, so that not all <code>Item</code> instances will be consumable.</p>
<p>Because <code>consumable</code> is now an optional attribute, we need to adjust <code>actions.py</code> to take this into account:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class ItemAction(Action):
    ...

    def perform(self) -&gt; None:
        &#34;&#34;&#34;Invoke the items ability, this action will be given to provide context.&#34;&#34;&#34;
<span style="color:#f92672">-       self.item.consumable.activate(self)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       if self.item.consumable:
</span><span style="color:#a6e22e">+           self.item.consumable.activate(self)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class ItemAction(Action):
    ...

    def perform(self) -> None:
        """Invoke the items ability, this action will be given to provide context."""
        <span class="crossed-out-text">self.item.consumable.activate(self)</span>
        <span class="new-text">if self.item.consumable:
            self.item.consumable.activate(self)</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>In order to actually create the equippable entities, we&rsquo;ll want to add a few examples to <code>entity_factories.py</code>. The entities we will add will correspond to the <code>Equippable</code> subclasses we already made. Edit <code>entity_factories.py</code> like this:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">from components.ai import HostileEnemy
<span style="color:#f92672">-from components import consumable
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+from components import consumable, equippable
</span><span style="color:#a6e22e"></span>from components.fighter import Fighter
from components.inventory import Inventory
from components.level import Level

...
lightning_scroll = Item(
    char=&#34;~&#34;,
    color=(255, 255, 0),
    name=&#34;Lightning Scroll&#34;,
    consumable=consumable.LightningDamageConsumable(damage=20, maximum_range=5),
)

<span style="color:#a6e22e">+dagger = Item(
</span><span style="color:#a6e22e">+   char=&#34;/&#34;, color=(0, 191, 255), name=&#34;Dagger&#34;, equippable=equippable.Dagger()
</span><span style="color:#a6e22e">+)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+sword = Item(char=&#34;/&#34;, color=(0, 191, 255), name=&#34;Sword&#34;, equippable=equippable.Sword())
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+leather_armor = Item(
</span><span style="color:#a6e22e">+   char=&#34;[&#34;,
</span><span style="color:#a6e22e">+   color=(139, 69, 19),
</span><span style="color:#a6e22e">+   name=&#34;Leather Armor&#34;,
</span><span style="color:#a6e22e">+   equippable=equippable.LeatherArmor(),
</span><span style="color:#a6e22e">+)
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+chain_mail = Item(
</span><span style="color:#a6e22e">+   char=&#34;[&#34;, color=(139, 69, 19), name=&#34;Chain Mail&#34;, equippable=equippable.ChainMail()
</span><span style="color:#a6e22e">+)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>from components.ai import HostileEnemy
<span class="crossed-out-text">from components import consumable</span>
<span class="new-text">from components import consumable, equippable</span>
from components.fighter import Fighter
from components.inventory import Inventory
from components.level import Level

...
lightning_scroll = Item(
    char="~",
    color=(255, 255, 0),
    name="Lightning Scroll",
    consumable=consumable.LightningDamageConsumable(damage=20, maximum_range=5),
)

<span class="new-text">dagger = Item(
    char="/", color=(0, 191, 255), name="Dagger", equippable=equippable.Dagger()
)

sword = Item(char="/", color=(0, 191, 255), name="Sword", equippable=equippable.Sword())

leather_armor = Item(
    char="[",
    color=(139, 69, 19),
    name="Leather Armor",
    equippable=equippable.LeatherArmor(),
)

chain_mail = Item(
    char="[", color=(139, 69, 19), name="Chain Mail", equippable=equippable.ChainMail()
)</span></pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>The creation of these entities is very similar to the consumables, except we give them the <code>Equippable</code> component instead of <code>Consumable</code>. This is all we need to do to create the entities themselves, but we&rsquo;re far from finished. We still need to make these entities appear on the map, make them equippable (there&rsquo;s nothing for them to attach <em>to</em> on the player right now), and make equipping them actually do something.</p>
<p>To handle the equipment that the player has equipped at the moment, we can create yet another component to handle the player&rsquo;s (or the monster&rsquo;s, for that matter) equipment. Create a new file called <code>equipment.py</code> in the <code>components</code> folder, and add these contents:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> annotations

<span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Optional, TYPE_CHECKING

<span style="color:#f92672">from</span> components.base_component <span style="color:#f92672">import</span> BaseComponent
<span style="color:#f92672">from</span> equipment_types <span style="color:#f92672">import</span> EquipmentType

<span style="color:#66d9ef">if</span> TYPE_CHECKING:
    <span style="color:#f92672">from</span> entity <span style="color:#f92672">import</span> Actor, Item


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Equipment</span>(BaseComponent):
    parent: Actor

    <span style="color:#66d9ef">def</span> __init__(self, weapon: Optional[Item] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, armor: Optional[Item] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>):
        self<span style="color:#f92672">.</span>weapon <span style="color:#f92672">=</span> weapon
        self<span style="color:#f92672">.</span>armor <span style="color:#f92672">=</span> armor

    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">defense_bonus</span>(self) <span style="color:#f92672">-&gt;</span> int:
        bonus <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>weapon <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">and</span> self<span style="color:#f92672">.</span>weapon<span style="color:#f92672">.</span>equippable <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
            bonus <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>weapon<span style="color:#f92672">.</span>equippable<span style="color:#f92672">.</span>defense_bonus

        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>armor <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">and</span> self<span style="color:#f92672">.</span>armor<span style="color:#f92672">.</span>equippable <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
            bonus <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>armor<span style="color:#f92672">.</span>equippable<span style="color:#f92672">.</span>defense_bonus

        <span style="color:#66d9ef">return</span> bonus

    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">power_bonus</span>(self) <span style="color:#f92672">-&gt;</span> int:
        bonus <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>weapon <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">and</span> self<span style="color:#f92672">.</span>weapon<span style="color:#f92672">.</span>equippable <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
            bonus <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>weapon<span style="color:#f92672">.</span>equippable<span style="color:#f92672">.</span>power_bonus

        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>armor <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">and</span> self<span style="color:#f92672">.</span>armor<span style="color:#f92672">.</span>equippable <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
            bonus <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>armor<span style="color:#f92672">.</span>equippable<span style="color:#f92672">.</span>power_bonus

        <span style="color:#66d9ef">return</span> bonus

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">item_is_equipped</span>(self, item: Item) <span style="color:#f92672">-&gt;</span> bool:
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>weapon <span style="color:#f92672">==</span> item <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>armor <span style="color:#f92672">==</span> item

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">unequip_message</span>(self, item_name: str) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
        self<span style="color:#f92672">.</span>parent<span style="color:#f92672">.</span>gamemap<span style="color:#f92672">.</span>engine<span style="color:#f92672">.</span>message_log<span style="color:#f92672">.</span>add_message(
            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;You remove the </span><span style="color:#e6db74">{</span>item_name<span style="color:#e6db74">}</span><span style="color:#e6db74">.&#34;</span>
        )

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">equip_message</span>(self, item_name: str) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
        self<span style="color:#f92672">.</span>parent<span style="color:#f92672">.</span>gamemap<span style="color:#f92672">.</span>engine<span style="color:#f92672">.</span>message_log<span style="color:#f92672">.</span>add_message(
            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;You equip the </span><span style="color:#e6db74">{</span>item_name<span style="color:#e6db74">}</span><span style="color:#e6db74">.&#34;</span>
        )

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">equip_to_slot</span>(self, slot: str, item: Item, add_message: bool) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
        current_item <span style="color:#f92672">=</span> getattr(self, slot)

        <span style="color:#66d9ef">if</span> current_item <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
            self<span style="color:#f92672">.</span>unequip_from_slot(slot, add_message)

        setattr(self, slot, item)

        <span style="color:#66d9ef">if</span> add_message:
            self<span style="color:#f92672">.</span>equip_message(item<span style="color:#f92672">.</span>name)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">unequip_from_slot</span>(self, slot: str, add_message: bool) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
        current_item <span style="color:#f92672">=</span> getattr(self, slot)

        <span style="color:#66d9ef">if</span> add_message:
            self<span style="color:#f92672">.</span>unequip_message(current_item<span style="color:#f92672">.</span>name)

        setattr(self, slot, <span style="color:#66d9ef">None</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">toggle_equip</span>(self, equippable_item: Item, add_message: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
        <span style="color:#66d9ef">if</span> (
            equippable_item<span style="color:#f92672">.</span>equippable
            <span style="color:#f92672">and</span> equippable_item<span style="color:#f92672">.</span>equippable<span style="color:#f92672">.</span>equipment_type <span style="color:#f92672">==</span> EquipmentType<span style="color:#f92672">.</span>WEAPON
        ):
            slot <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;weapon&#34;</span>
        <span style="color:#66d9ef">else</span>:
            slot <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;armor&#34;</span>

        <span style="color:#66d9ef">if</span> getattr(self, slot) <span style="color:#f92672">==</span> equippable_item:
            self<span style="color:#f92672">.</span>unequip_from_slot(slot, add_message)
        <span style="color:#66d9ef">else</span>:
            self<span style="color:#f92672">.</span>equip_to_slot(slot, equippable_item, add_message)
</code></pre></div><p>That&rsquo;s a lot to take in, so let&rsquo;s go through it bit by bit.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Equipment</span>(BaseComponent):
    parent: Actor

    <span style="color:#66d9ef">def</span> __init__(self, weapon: Optional[Item] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, armor: Optional[Item] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>):
        self<span style="color:#f92672">.</span>weapon <span style="color:#f92672">=</span> weapon
        self<span style="color:#f92672">.</span>armor <span style="color:#f92672">=</span> armor
</code></pre></div><p>The <code>weapon</code> and <code>armor</code> attributes are what will hold the actual equippable entity. Both can be set to <code>None</code>, which represents nothing equipped in those slots. Feel free to add more slots as you see fit (perhaps you want <code>armor</code> to be head, body, legs, etc. instead, or allow for off-hand weapons/shields).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3">    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">defense_bonus</span>(self) <span style="color:#f92672">-&gt;</span> int:
        bonus <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>weapon <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">and</span> self<span style="color:#f92672">.</span>weapon<span style="color:#f92672">.</span>equippable <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
            bonus <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>weapon<span style="color:#f92672">.</span>equippable<span style="color:#f92672">.</span>defense_bonus

        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>armor <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">and</span> self<span style="color:#f92672">.</span>armor<span style="color:#f92672">.</span>equippable <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
            bonus <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>armor<span style="color:#f92672">.</span>equippable<span style="color:#f92672">.</span>defense_bonus

        <span style="color:#66d9ef">return</span> bonus

    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">power_bonus</span>(self) <span style="color:#f92672">-&gt;</span> int:
        bonus <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>weapon <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">and</span> self<span style="color:#f92672">.</span>weapon<span style="color:#f92672">.</span>equippable <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
            bonus <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>weapon<span style="color:#f92672">.</span>equippable<span style="color:#f92672">.</span>power_bonus

        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>armor <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">and</span> self<span style="color:#f92672">.</span>armor<span style="color:#f92672">.</span>equippable <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
            bonus <span style="color:#f92672">+=</span> self<span style="color:#f92672">.</span>armor<span style="color:#f92672">.</span>equippable<span style="color:#f92672">.</span>power_bonus

        <span style="color:#66d9ef">return</span> bonus
</code></pre></div><p>These properties do the same thing, just for different things. Both calculate the &ldquo;bonus&rdquo; gifted by equipment to either defense or power, based on what&rsquo;s equipped. Notice that we take the &ldquo;power&rdquo; bonus from both weapons and armor, and the same applies to the &ldquo;defense&rdquo; bonus. This allows you to create weapons that increase both attack and defense (maybe some sort of spiked shield) and armor that increases attack (something magical, maybe). We won&rsquo;t do that in this tutorial (weapons will only increase power, armor will only increase defense), but you should experiment with different equipment types on your own.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3">    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">item_is_equipped</span>(self, item: Item) <span style="color:#f92672">-&gt;</span> bool:
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>weapon <span style="color:#f92672">==</span> item <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>armor <span style="color:#f92672">==</span> item
</code></pre></div><p>This allows us to quickly check if an <code>Item</code> is equipped by the player or not. It will come in handy later on.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3">    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">unequip_message</span>(self, item_name: str) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
        self<span style="color:#f92672">.</span>parent<span style="color:#f92672">.</span>gamemap<span style="color:#f92672">.</span>engine<span style="color:#f92672">.</span>message_log<span style="color:#f92672">.</span>add_message(
            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;You remove the </span><span style="color:#e6db74">{</span>item_name<span style="color:#e6db74">}</span><span style="color:#e6db74">.&#34;</span>
        )

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">equip_message</span>(self, item_name: str) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
        self<span style="color:#f92672">.</span>parent<span style="color:#f92672">.</span>gamemap<span style="color:#f92672">.</span>engine<span style="color:#f92672">.</span>message_log<span style="color:#f92672">.</span>add_message(
            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;You equip the </span><span style="color:#e6db74">{</span>item_name<span style="color:#e6db74">}</span><span style="color:#e6db74">.&#34;</span>
        )
</code></pre></div><p>Both of these methods add a message to the message log, depending on whether the player is equipping or removing a piece of equipment.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3">    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">equip_to_slot</span>(self, slot: str, item: Item, add_message: bool) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
        current_item <span style="color:#f92672">=</span> getattr(self, slot)

        <span style="color:#66d9ef">if</span> current_item <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
            self<span style="color:#f92672">.</span>unequip_from_slot(slot, add_message)

        setattr(self, slot, item)

        <span style="color:#66d9ef">if</span> add_message:
            self<span style="color:#f92672">.</span>equip_message(item<span style="color:#f92672">.</span>name)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">unequip_from_slot</span>(self, slot: str, add_message: bool) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
        current_item <span style="color:#f92672">=</span> getattr(self, slot)

        <span style="color:#66d9ef">if</span> add_message:
            self<span style="color:#f92672">.</span>unequip_message(current_item<span style="color:#f92672">.</span>name)

        setattr(self, slot, <span style="color:#66d9ef">None</span>)
</code></pre></div><p><code>equip_to_slot</code> and <code>unequip_from_slot</code> with add or remove an Item to the given &ldquo;slot&rdquo; (<code>weapon</code> or <code>armor</code>). We use <code>getattr</code> to get the slot, whether it&rsquo;s <code>weapon</code> or <code>armor</code>. We use <code>getattr</code> because we won&rsquo;t actually know which one we&rsquo;re getting until the function is called. <code>getattr</code> allows us to &ldquo;get an attribute&rdquo; on a class (<code>self</code> in this case) and do what we want with it. We use <code>setattr</code> to &ldquo;set the attribute&rdquo; the same way.</p>
<p><code>unequip_from_slot</code> simply removes the item. <code>equip_to_slot</code> first checks if there&rsquo;s something equipped to that slot, and calls <code>unequip_from_slot</code> if there is. This way, the player can&rsquo;t equip two things to the same slot.</p>
<p>What&rsquo;s with the <code>add_message</code> part? Normally, we&rsquo;ll want to add a message to the message log when we equip/remove things, but in this section, we&rsquo;ll see an exception: When we set up the player&rsquo;s initial equipment. We&rsquo;ll use the same &ldquo;equip&rdquo; methods to set up the initial equipment, but there&rsquo;s no need to begin every game with messages that say the player put on their starting equipment (presumably, the player character did this before walking into the deadly dungeon). <code>add_message</code> gives us a simple way to not add the messages if they aren&rsquo;t necessary. In your game, there might be other scenarios where you don&rsquo;t want to display these messages.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3">    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">toggle_equip</span>(self, equippable_item: Item, add_message: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
        <span style="color:#66d9ef">if</span> (
            equippable_item<span style="color:#f92672">.</span>equippable
            <span style="color:#f92672">and</span> equippable_item<span style="color:#f92672">.</span>equippable<span style="color:#f92672">.</span>equipment_type <span style="color:#f92672">==</span> EquipmentType<span style="color:#f92672">.</span>WEAPON
        ):
            slot <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;weapon&#34;</span>
        <span style="color:#66d9ef">else</span>:
            slot <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;armor&#34;</span>

        <span style="color:#66d9ef">if</span> getattr(self, slot) <span style="color:#f92672">==</span> equippable_item:
            self<span style="color:#f92672">.</span>unequip_from_slot(slot, add_message)
        <span style="color:#66d9ef">else</span>:
            self<span style="color:#f92672">.</span>equip_to_slot(slot, equippable_item, add_message)
</code></pre></div><p>Finally, we have <code>toggle_equip</code>, which is the method that will actually get called when the player selects an equippable item. It checks the equipment&rsquo;s type (to know which slot to put it in), and then checks to see if the same item is already equipped to that slot. If it is, the player presumably wants to remove it. If not, the player wants to equip it.</p>
<p>To sum up, this component holds references to equippable entities, calculates the bonuses the player gets from them (which will get added to the player&rsquo;s power and defense values), and gives a way to equip or remove the items.</p>
<p>Let&rsquo;s add this component to the actors now. <code>entity.py</code> and add these lines:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">...
if TYPE_CHECKING:
    from components.ai import BaseAI
    from components.consumable import Consumable
<span style="color:#a6e22e">+   from components.equipment import Equipment
</span><span style="color:#a6e22e"></span>    from components.equippable import Equippable
    from components.fighter import Fighter
    from components.inventory import Inventory
    from components.level import Level
    from game_map import GameMap
...

class Actor(Entity):
    def __init__(
        self,
        *,
        x: int = 0,
        y: int = 0,
        char: str = &#34;?&#34;,
        color: Tuple[int, int, int] = (255, 255, 255),
        name: str = &#34;&lt;Unnamed&gt;&#34;,
        ai_cls: Type[BaseAI],
<span style="color:#a6e22e">+       equipment: Equipment,
</span><span style="color:#a6e22e"></span>        fighter: Fighter,
        inventory: Inventory,
        level: Level,
    ):
        super().__init__(
            x=x,
            y=y,
            char=char,
            color=color,
            name=name,
            blocks_movement=True,
            render_order=RenderOrder.ACTOR,
        )

        self.ai: Optional[BaseAI] = ai_cls(self)

<span style="color:#a6e22e">+       self.equipment: Equipment = equipment
</span><span style="color:#a6e22e">+       self.equipment.parent = self
</span><span style="color:#a6e22e"></span>
        self.fighter = fighter
        self.fighter.parent = self

        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>...
if TYPE_CHECKING:
    from components.ai import BaseAI
    from components.consumable import Consumable
    <span class="new-text">from components.equipment import Equipment</span>
    from components.equippable import Equippable
    from components.fighter import Fighter
    from components.inventory import Inventory
    from components.level import Level
    from game_map import GameMap
...

class Actor(Entity):
    def __init__(
        self,
        *,
        x: int = 0,
        y: int = 0,
        char: str = "?",
        color: Tuple[int, int, int] = (255, 255, 255),
        name: str = "&lt;Unnamed&gt;",
        ai_cls: Type[BaseAI],
        <span class="new-text">equipment: Equipment,</span>
        fighter: Fighter,
        inventory: Inventory,
        level: Level,
    ):
        super().__init__(
            x=x,
            y=y,
            char=char,
            color=color,
            name=name,
            blocks_movement=True,
            render_order=RenderOrder.ACTOR,
        )

        self.ai: Optional[BaseAI] = ai_cls(self)

        <span class="new-text">self.equipment: Equipment = equipment
        self.equipment.parent = self</span>

        self.fighter = fighter
        self.fighter.parent = self

        ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>We also need to update <code>entity_factories.py</code> once again, to create the actors with the <code>Equipment</code> component:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">from components.ai import HostileEnemy
from components import consumable, equippable
<span style="color:#a6e22e">+from components.equipment import Equipment
</span><span style="color:#a6e22e"></span>from components.fighter import Fighter
from components.inventory import Inventory
from components.level import Level


player = Actor(
    char=&#34;@&#34;,
    color=(255, 255, 255),
    name=&#34;Player&#34;,
    ai_cls=HostileEnemy,
<span style="color:#a6e22e">+   equipment=Equipment(),
</span><span style="color:#a6e22e"></span>    fighter=Fighter(hp=30, base_defense=1, base_power=2),
    inventory=Inventory(capacity=26),
    level=Level(level_up_base=200),
)
orc = Actor(
    char=&#34;o&#34;,
    color=(63, 127, 63),
    name=&#34;Orc&#34;,
    ai_cls=HostileEnemy,
<span style="color:#a6e22e">+   equipment=Equipment(),
</span><span style="color:#a6e22e"></span>    fighter=Fighter(hp=10, base_defense=0, base_power=3),
    inventory=Inventory(capacity=0),
    level=Level(xp_given=35),
)
troll = Actor(
    char=&#34;T&#34;,
    color=(0, 127, 0),
    name=&#34;Troll&#34;,
    ai_cls=HostileEnemy,
<span style="color:#a6e22e">+   equipment=Equipment(),
</span><span style="color:#a6e22e"></span>    fighter=Fighter(hp=16, base_defense=1, base_power=4),
    inventory=Inventory(capacity=0),
    level=Level(xp_given=100),
)
...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>from components.ai import HostileEnemy
from components import consumable, equippable
<span class="new-text">from components.equipment import Equipment</span>
from components.fighter import Fighter
from components.inventory import Inventory
from components.level import Level


player = Actor(
    char="@",
    color=(255, 255, 255),
    name="Player",
    ai_cls=HostileEnemy,
    <span class="new-text">equipment=Equipment(),</span>
    fighter=Fighter(hp=30, base_defense=1, base_power=2),
    inventory=Inventory(capacity=26),
    level=Level(level_up_base=200),
)
orc = Actor(
    char="o",
    color=(63, 127, 63),
    name="Orc",
    ai_cls=HostileEnemy,
    <span class="new-text">equipment=Equipment(),</span>
    fighter=Fighter(hp=10, base_defense=0, base_power=3),
    inventory=Inventory(capacity=0),
    level=Level(xp_given=35),
)
troll = Actor(
    char="T",
    color=(0, 127, 0),
    name="Troll",
    ai_cls=HostileEnemy,
    <span class="new-text">equipment=Equipment(),</span>
    fighter=Fighter(hp=16, base_defense=1, base_power=4),
    inventory=Inventory(capacity=0),
    level=Level(xp_given=100),
)
...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>One thing we need to do is change the way <code>power</code> and <code>defense</code> are calculated in the <code>Fighter</code> component. Currently, the values are set directly in the class, but we&rsquo;ll want to calculate them based on their base values (what gets leveled up), and the bonus values (based on the equipment).</p>
<p>We can redefine <code>power</code> and <code>defense</code> as properties, and rename what we set in the class to <code>base_power</code> and <code>base_defense</code>. <code>power</code> and <code>defense</code> will then get their values from their respective bases and equipment bonuses.</p>
<p>This will require edits to several places, but we&rsquo;ll start first with the most obvious: the <code>Fighter</code> class itself.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class Fighter(BaseComponent):
    parent: Actor

<span style="color:#f92672">-   def __init__(self, hp: int, defense: int, power: int):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   def __init__(self, hp: int, base_defense: int, base_power: int):
</span><span style="color:#a6e22e"></span>        self.max_hp = hp
        self._hp = hp
<span style="color:#f92672">-       self.defense = defense
</span><span style="color:#f92672">-       self.power = power
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       self.base_defense = base_defense
</span><span style="color:#a6e22e">+       self.base_power = base_power
</span><span style="color:#a6e22e"></span>
    @property
    def hp(self) -&gt; int:
        return self._hp

    @hp.setter
    def hp(self, value: int) -&gt; None:
        self._hp = max(0, min(value, self.max_hp))
        if self._hp == 0 and self.parent.ai:
            self.die()

<span style="color:#a6e22e">+   @property
</span><span style="color:#a6e22e">+   def defense(self) -&gt; int:
</span><span style="color:#a6e22e">+       return self.base_defense + self.defense_bonus
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+   @property
</span><span style="color:#a6e22e">+   def power(self) -&gt; int:
</span><span style="color:#a6e22e">+       return self.base_power + self.power_bonus
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+   @property
</span><span style="color:#a6e22e">+   def defense_bonus(self) -&gt; int:
</span><span style="color:#a6e22e">+       if self.parent.equipment:
</span><span style="color:#a6e22e">+           return self.parent.equipment.defense_bonus
</span><span style="color:#a6e22e">+       else:
</span><span style="color:#a6e22e">+           return 0
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+   @property
</span><span style="color:#a6e22e">+   def power_bonus(self) -&gt; int:
</span><span style="color:#a6e22e">+       if self.parent.equipment:
</span><span style="color:#a6e22e">+           return self.parent.equipment.power_bonus
</span><span style="color:#a6e22e">+       else:
</span><span style="color:#a6e22e">+           return 0
</span><span style="color:#a6e22e"></span>
    def die(self) -&gt; None:
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class Fighter(BaseComponent):
    parent: Actor

    <span class="crossed-out-text">def __init__(self, hp: int, defense: int, power: int):</span>
    <span class="new-text">def __init__(self, hp: int, base_defense: int, base_power: int):</span>
        self.max_hp = hp
        self._hp = hp
        <span class="crossed-out-text">self.defense = defense</span>
        <span class="crossed-out-text">self.power = power</span>
        <span class="new-text">self.base_defense = base_defense
        self.base_power = base_power</span>

    @property
    def hp(self) -> int:
        return self._hp

    @hp.setter
    def hp(self, value: int) -> None:
        self._hp = max(0, min(value, self.max_hp))
        if self._hp == 0 and self.parent.ai:
            self.die()

    <span class="new-text">@property
    def defense(self) -> int:
        return self.base_defense + self.defense_bonus

    @property
    def power(self) -> int:
        return self.base_power + self.power_bonus

    @property
    def defense_bonus(self) -> int:
        if self.parent.equipment:
            return self.parent.equipment.defense_bonus
        else:
            return 0

    @property
    def power_bonus(self) -> int:
        if self.parent.equipment:
            return self.parent.equipment.power_bonus
        else:
            return 0</span>

    def die(self) -> None:
        ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p><code>power</code> and <code>defense</code> are now computed based on the base values and the bonus values offered by the equipment (if any exists).</p>
<p>We&rsquo;ll need to edit <code>level.py</code> to reflect the new attribute names as well:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class Level(BaseComponent):
    ...

    def increase_power(self, amount: int = 1) -&gt; None:
<span style="color:#f92672">-       self.parent.fighter.power += amount
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       self.parent.fighter.base_power += amount
</span><span style="color:#a6e22e"></span>
        self.engine.message_log.add_message(&#34;You feel stronger!&#34;)

        self.increase_level()

    def increase_defense(self, amount: int = 1) -&gt; None:
<span style="color:#f92672">-       self.parent.fighter.defense += amount
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       self.parent.fighter.base_defense += amount
</span><span style="color:#a6e22e"></span>
        self.engine.message_log.add_message(&#34;Your movements are getting swifter!&#34;)
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class Level(BaseComponent):
    ...

    def increase_power(self, amount: int = 1) -> None:
        <span class="crossed-out-text">self.parent.fighter.power += amount</span>
        <span class="new-text">self.parent.fighter.base_power += amount</span>

        self.engine.message_log.add_message("You feel stronger!")

        self.increase_level()

    def increase_defense(self, amount: int = 1) -> None:
        <span class="crossed-out-text">self.parent.fighter.defense += amount</span>
        <span class="new-text">self.parent.fighter.base_defense += amount</span>

        self.engine.message_log.add_message("Your movements are getting swifter!")</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>We also have to adjust the initializations in <code>entity_factories.py</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">player = Actor(
    char=&#34;@&#34;,
    color=(255, 255, 255),
    name=&#34;Player&#34;,
    ai_cls=HostileEnemy,
    equipment=Equipment(),
<span style="color:#f92672">-   fighter=Fighter(hp=30, defense=2, power=5),
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   fighter=Fighter(hp=30, base_defense=1, base_power=2),
</span><span style="color:#a6e22e"></span>    inventory=Inventory(capacity=26),
    level=Level(level_up_base=200),
)
orc = Actor(
    char=&#34;o&#34;,
    color=(63, 127, 63),
    name=&#34;Orc&#34;,
    ai_cls=HostileEnemy,
    equipment=Equipment(),
<span style="color:#f92672">-   fighter=Fighter(hp=10, defense=0, power=3),
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   fighter=Fighter(hp=10, base_defense=0, base_power=3),
</span><span style="color:#a6e22e"></span>    inventory=Inventory(capacity=0),
    level=Level(xp_given=35),
)
troll = Actor(
    char=&#34;T&#34;,
    color=(0, 127, 0),
    name=&#34;Troll&#34;,
    ai_cls=HostileEnemy,
    equipment=Equipment(),
<span style="color:#f92672">-   fighter=Fighter(hp=16, defense=1, power=4),
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   fighter=Fighter(hp=16, base_defense=1, base_power=4),
</span><span style="color:#a6e22e"></span>    inventory=Inventory(capacity=0),
    level=Level(xp_given=100),
)
...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>player = Actor(
    char="@",
    color=(255, 255, 255),
    name="Player",
    ai_cls=HostileEnemy,
    equipment=Equipment(),
    <span class="crossed-out-text">fighter=Fighter(hp=30, defense=2, power=5),</span>
    <span class="new-text">fighter=Fighter(hp=30, base_defense=1, base_power=2),</span>
    inventory=Inventory(capacity=26),
    level=Level(level_up_base=200),
)
orc = Actor(
    char="o",
    color=(63, 127, 63),
    name="Orc",
    ai_cls=HostileEnemy,
    equipment=Equipment(),
    <span class="crossed-out-text">fighter=Fighter(hp=10, defense=0, power=3),</span>
    <span class="new-text">fighter=Fighter(hp=10, base_defense=0, base_power=3),</span>
    inventory=Inventory(capacity=0),
    level=Level(xp_given=35),
)
troll = Actor(
    char="T",
    color=(0, 127, 0),
    name="Troll",
    ai_cls=HostileEnemy,
    equipment=Equipment(),
    <span class="crossed-out-text">fighter=Fighter(hp=16, defense=1, power=4),</span>
    <span class="new-text">fighter=Fighter(hp=16, base_defense=1, base_power=4),</span>
    inventory=Inventory(capacity=0),
    level=Level(xp_given=100),
)
...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>Notice that we&rsquo;ve changed the player&rsquo;s base values a bit. This is to compensate for the fact that the player will be getting bonuses from the equipment soon. Feel free to tweak these values however you see fit.</p>
<p>Now all that&rsquo;s left to do is allow generate the equipment to the map, and allow the player to interact with it. To create equipment, we can simply edit our <code>item_chances</code> dictionary to include weapons and armor on certain floors. Edit <code>procgen.py</code> like this:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">item_chances: Dict[int, List[Tuple[Entity, int]]] = {
    0: [(entity_factories.health_potion, 35)],
    2: [(entity_factories.confusion_scroll, 10)],
<span style="color:#f92672">-   4: [(entity_factories.lightning_scroll, 25)],
</span><span style="color:#f92672">-   6: [(entity_factories.fireball_scroll, 25)],
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   4: [(entity_factories.lightning_scroll, 25), (entity_factories.sword, 5)],
</span><span style="color:#a6e22e">+   6: [(entity_factories.fireball_scroll, 25), (entity_factories.chain_mail, 15)],
</span><span style="color:#a6e22e"></span>}
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>item_chances: Dict[int, List[Tuple[Entity, int]]] = {
    0: [(entity_factories.health_potion, 35)],
    2: [(entity_factories.confusion_scroll, 10)],
    <span class="crossed-out-text">4: [(entity_factories.lightning_scroll, 25)],</span>
    <span class="crossed-out-text">6: [(entity_factories.fireball_scroll, 25)],</span>
    <span class="new-text">4: [(entity_factories.lightning_scroll, 25), (entity_factories.sword, 5)],</span>
    <span class="new-text">6: [(entity_factories.fireball_scroll, 25), (entity_factories.chain_mail, 15)],</span>
}</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>This will generate swords and chain mail at levels 4 and 6, respectively. You can change the floor or the weights if you like.</p>
<p>Now that equipment will spawn on the map, we need to allow the user to equip and remove equippable entities. The first step is to add an action to equip things, which we&rsquo;ll call <code>EquipAction</code>. Add this class to <code>actions.py</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">...
class DropItem(ItemAction):
    ...


<span style="color:#a6e22e">+class EquipAction(Action):
</span><span style="color:#a6e22e">+   def __init__(self, entity: Actor, item: Item):
</span><span style="color:#a6e22e">+       super().__init__(entity)
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+       self.item = item
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+   def perform(self) -&gt; None:
</span><span style="color:#a6e22e">+       self.entity.equipment.toggle_equip(self.item)
</span><span style="color:#a6e22e"></span>

class WaitAction(Action):
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>...
class DropItem(ItemAction):
    ...


<span class="new-text">class EquipAction(Action):
    def __init__(self, entity: Actor, item: Item):
        super().__init__(entity)

        self.item = item

    def perform(self) -> None:
        self.entity.equipment.toggle_equip(self.item)</span>


class WaitAction(Action):
    ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>The action itself is very straightforward: It holds which item is being equipped/removed, and calls the <code>toggle_equip</code> method. The <code>Equipment</code> component handles most of the work here.</p>
<p>But how do we <em>use</em> this action? The simplest way would be to expand the functionality of our original inventory menu. If the user selects a piece of equipment from that menu, we&rsquo;ll either equip the item, or remove it, if it&rsquo;s already equipped. We should also show the user a visual representation of which items are already equipped.</p>
<p>Modify <code>input_handlers.py</code> like this:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class InventoryEventHandler(AskUserEventHandler):
    def on_render(self, console: tcod.Console) -&gt; None:
        ...

        if number_of_items_in_inventory &gt; 0:
            for i, item in enumerate(self.engine.player.inventory.items):
                item_key = chr(ord(&#34;a&#34;) + i)
<span style="color:#f92672">-               console.print(x + 1, y + i + 1, f&#34;({item_key}) {item.name}&#34;)
</span><span style="color:#f92672"></span>
<span style="color:#a6e22e">+               is_equipped = self.engine.player.equipment.item_is_equipped(item)
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+               item_string = f&#34;({item_key}) {item.name}&#34;
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+               if is_equipped:
</span><span style="color:#a6e22e">+                   item_string = f&#34;{item_string} (E)&#34;
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+               console.print(x + 1, y + i + 1, item_string)
</span><span style="color:#a6e22e"></span>        else:
            console.print(x + 1, y + 1, &#34;(Empty)&#34;)

    ...

class InventoryActivateHandler(InventoryEventHandler):
    &#34;&#34;&#34;Handle using an inventory item.&#34;&#34;&#34;

    TITLE = &#34;Select an item to use&#34;

    def on_item_selected(self, item: Item) -&gt; Optional[ActionOrHandler]:
<span style="color:#f92672">-       &#34;&#34;&#34;Return the action for the selected item.&#34;&#34;&#34;
</span><span style="color:#f92672">-       return item.consumable.get_action(self.engine.player)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       if item.consumable:
</span><span style="color:#a6e22e">+           # Return the action for the selected item.
</span><span style="color:#a6e22e">+           return item.consumable.get_action(self.engine.player)
</span><span style="color:#a6e22e">+       elif item.equippable:
</span><span style="color:#a6e22e">+           return actions.EquipAction(self.engine.player, item)
</span><span style="color:#a6e22e">+       else:
</span><span style="color:#a6e22e">+           return None
</span><span style="color:#a6e22e"></span>

class InventoryDropHandler(InventoryEventHandler):
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class InventoryEventHandler(AskUserEventHandler):
    def on_render(self, console: tcod.Console) -> None:
        ...

        if number_of_items_in_inventory > 0:
            for i, item in enumerate(self.engine.player.inventory.items):
                item_key = chr(ord("a") + i)
                <span class="crossed-out-text">console.print(x + 1, y + i + 1, f"({item_key}) {item.name}")</span>

                <span class="new-text">is_equipped = self.engine.player.equipment.item_is_equipped(item)

                item_string = f"({item_key}) {item.name}"

                if is_equipped:
                    item_string = f"{item_string} (E)"

                console.print(x + 1, y + i + 1, item_string)</span>
        else:
            console.print(x + 1, y + 1, "(Empty)")

    ...

class InventoryActivateHandler(InventoryEventHandler):
    """Handle using an inventory item."""

    TITLE = "Select an item to use"

    def on_item_selected(self, item: Item) -> Optional[ActionOrHandler]:
        <span class="crossed-out-text">"""Return the action for the selected item."""</span>
        <span class="crossed-out-text">return item.consumable.get_action(self.engine.player)</span>
        <span class="new-text">if item.consumable:
            # Return the action for the selected item.
            return item.consumable.get_action(self.engine.player)
        elif item.equippable:
            return actions.EquipAction(self.engine.player, item)
        else:
            return None</span>


class InventoryDropHandler(InventoryEventHandler):
    ...</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>The first change is modifying the render function to display an &ldquo;(E)&rdquo; next to items that are equipped. Items that aren&rsquo;t equipped are displayed the same way as before.</p>
<p>The second change has to do with using the item. Before, we were just assuming the item was a consumable. Now, if the item is a consumable, we call the <code>get_action</code> method on the <code>Consumable</code> component, just like before. If it&rsquo;s instead equippable, we call the <code>EquipAction</code>. If it&rsquo;s neither, nothing happens.</p>
<p>Run the game now, you&rsquo;ll be able to pick up and equip things. I recommend adjusting the values in <code>procgen.py</code> to make equipment spawn earlier and more often, just for testing purposes.</p>
<p>If you play around a bit, you might notice an odd bug: If the player drops something that&rsquo;s equipped&hellip; it stays equipped! That doesn&rsquo;t make sense, as dropping something should unequip it as well. Luckily, the fix is quite simple: We can adjust our <code>DropItem</code> action to unequip an item if it&rsquo;s being dropped and it&rsquo;s equipped. Make the following additions to <code>actions.py</code>:</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class DropItem(ItemAction):
    def perform(self) -&gt; None:
<span style="color:#a6e22e">+       if self.entity.equipment.item_is_equipped(self.item):
</span><span style="color:#a6e22e">+           self.entity.equipment.toggle_equip(self.item)
</span><span style="color:#a6e22e"></span>
        self.entity.inventory.drop(self.item)
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class DropItem(ItemAction):
    def perform(self) -> None:
        <span class="new-text">if self.entity.equipment.item_is_equipped(self.item):
            self.entity.equipment.toggle_equip(self.item)</span>

        self.entity.inventory.drop(self.item)</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>One last thing we can do is give the player a bit of equipment to start. We&rsquo;ll spawn a dagger and leather armor, and immediately add them to the player&rsquo;s inventory.</p>
<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

  
<div class="data-pane active" data-pane="diff">
  
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def new_game() -&gt; Engine:
    ...

    engine.message_log.add_message(
        &#34;Hello and welcome, adventurer, to yet another dungeon!&#34;, color.welcome_text
    )

<span style="color:#a6e22e">+   dagger = copy.deepcopy(entity_factories.dagger)
</span><span style="color:#a6e22e">+   leather_armor = copy.deepcopy(entity_factories.leather_armor)
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+   dagger.parent = player.inventory
</span><span style="color:#a6e22e">+   leather_armor.parent = player.inventory
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+   player.inventory.items.append(dagger)
</span><span style="color:#a6e22e">+   player.equipment.toggle_equip(dagger, add_message=False)
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+   player.inventory.items.append(leather_armor)
</span><span style="color:#a6e22e">+   player.equipment.toggle_equip(leather_armor, add_message=False)
</span><span style="color:#a6e22e"></span>
    return engine
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>def new_game() -> Engine:
    ...

    engine.message_log.add_message(
        "Hello and welcome, adventurer, to yet another dungeon!", color.welcome_text
    )

    <span class="new-text">dagger = copy.deepcopy(entity_factories.dagger)
    leather_armor = copy.deepcopy(entity_factories.leather_armor)

    dagger.parent = player.inventory
    leather_armor.parent = player.inventory

    player.inventory.items.append(dagger)
    player.equipment.toggle_equip(dagger, add_message=False)

    player.inventory.items.append(leather_armor)
    player.equipment.toggle_equip(leather_armor, add_message=False)</span>

    return engine</pre>

</div>

</div>

<script src="/js/codetabs.js"></script>
<p>As mentioned earlier, we pass <code>add_message=False</code> to signify not to add a message to the message log.</p>
<p><img src="/images/part-13-end.png" alt="Part 13 - End"></p>
<p>With that, we&rsquo;ve reached the end of the tutorial! Thank you so much for following along, and be sure to check out the <a href="/tutorials/tcod/v2">extras section</a>. More will be added there over time. If you have a suggestion for an extra, let me know!</p>
<p>Be sure to check out the <a href="https://www.reddit.com/r/roguelikedev">Roguelike Development Subreddit</a> for help, for inspiration, or to share your progress.</p>
<p>Best of luck on your roguelike development journey!</p>
<p>If you want to see the code so far in its entirety, <a href="https://github.com/TStand90/tcod_tutorial_v2/tree/2020/part-13">click here</a>.</p>


    

    


</article>



        </div>

        <aside class="col-12 col-lg-3 ml-auto blog-sidebar">
    
    
        <section>
    
        
    
        
    
</section>
    
</aside>

      </div>
    </div>
    

    
      







<footer class="blog-footer w-100">
    <nav class="navbar navbar-light bg-light">
        <p class="w-100 text-center">Last updated July 7th, 2020</p>
        <p class="w-100 text-center"><a href="#">Back to top</a></p>
    </nav>
</footer>

    

    
    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  </body>
</html>
